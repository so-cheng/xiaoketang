@{
    Layout = ModelBasic.PageModel.GetLayout();
}

@using WeiCode.Utility;
@using WeiCode.DataBase;
@using WeiCode.Services;
@using WeiCode.ModelDbs;
@using WeiCode.Domain;
@using Services.Project;
@using WeiCode.Models;

<style>
    .layui-table td, .layui-table th, .layui-table-col-set, .layui-table-fixed-r,
    .layui-table-grid-down, .layui-table-header, .layui-table-page, .layui-table-tips-main,
    .layui-table-tool, .layui-table-total, .layui-table-view, .layui-table[lay-skin=line], .layui-table[lay-skin=row] {
        border-color: gray;
    }

    .layui-table th {
        text-align: center;
        font-weight: 700;
        font-size: 14px;
    }

    .layui-table td {
        font-size: 14px;
    }

    /* 表头固定样式 */
    .layui-table {
        position: relative;
    }

        .layui-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: white;
        }

            .layui-table thead tr:first-child {
                position: sticky;
                top: 0;
                z-index: 11;
                background-color: #FFF3CA;
            }

            .layui-table thead tr:nth-child(2) {
                position: sticky;
                top: 50px; /* 第一行表头的高度 */
                z-index: 11;
                background-color: #FCE4D3;
            }

            /* 确保表头有足够的背景色 */
            .layui-table thead th {
                background-color: inherit;
            }
</style>
<style>
    .layuiadmin-big-font {
        font-weight: bold;
        font-size: 42px;
        margin: 10px;
    }
</style>
<blockquote class="layui-elem-quote news_search">
    <div class="layui-inline">
        <form class="layui-form">
            <div class="layui-input-inline">
                <label class="layui-form-label">日期</label>
            </div>
            <div class="layui-inline">
                <div class="layui-input-inline">
                    @ViewModelBag.Load(Html, new ModelBasic.EmtTimeSelect("dateRange")
                    {
                        title = "申请日期",
                        defaultValue = ViewBag.dateRange,
                        mold = ModelBasic.EmtTimeSelect.Mold.date_range,
                        eventJsChange = new EmtFormBase.EventJsChange
                        {
                            eventJavascript = new EventJavascript
                            {
                                code = "window.location.href = '/JoinNew/DatasShow/ApproveSumTable?dateRange=' + page.dateRange.value;"
                            },
                        },
                        placeholder = "补人申请日期筛选",
                    })
                </div>
            </div>
            <div class="layui-input-inline">
                <label class="layui-input-inline">@(DoMySql.FindEntity<ModelDb.sys_biz_log>($"tenant_id = {new DomainBasic.TenantApp().GetInfo().id} and modular_function = '定时任务' and relation_sn = '补人团队数据' order by create_time desc", false).memo)</label>
            </div>
        </form>
    </div>
</blockquote>
<body>
    <div>
        <table class="layui-table" style="text-align: center; background-color: #FCE4D3;" id="table1" name="table1">
            <colgroup>
                <col width="100">
                <col width="100">
                <col width="100">
                <col width="100">
                <col width="100">

                <col width="100">
                <col width="100">
                <col width="100">
                <col width="100">

                <col width="100">
                <col width="100">
                <col width="100">

                <col width="100">
                <col width="100">
                <col width="100">
                <col width="100">
            </colgroup>
            <thead>
                <tr style="background-color: #FFF3CA; ">
                    <th rowspan="2">运营团队</th>
                    <th rowspan="2">申请数</th>
                    <th rowspan="2">未分配</th>
                    <th rowspan="2">待拉群</th>
                    <th rowspan="2">已拉群</th>

                    <th rowspan="2">分配前流失数</th>
                    <th colspan="2">分配后流失数</th>

                    <th colspan="2">申请数</th>
                    <th colspan="2">培训名单总数</th>
                    <th colspan="2">已分配总数</th>
                    <th colspan="2">已拉群总数</th>
                </tr>

                <tr style="background-color: #FFF3CA; ">
                    <th>未培训</th>
                    <th>已培训</th>
                    <th>男生数</th>
                    <th>女生数</th>
                    <th>男生数</th>
                    <th>女生数</th>
                    <th>男生数</th>
                    <th>女生数</th>
                    <th>男生数</th>
                    <th>女生数</th>
                </tr>
            </thead>
            <tbody>
                @{
                    string where = $"tenant_id = {new DomainBasic.TenantApp().GetInfo().id}";
                    string feild_sum = "yy_user_sn, yy_name, sum(zb_sum) zb_sum, sum(unsupplement_sum) unsupplement_sum, sum(uninqun_sum) uninqun_sum, sum(inqun_sum) inqun_sum, sum(b_allocation_loss) b_allocation_loss, sum(b_traning_loss) b_traning_loss, sum(b_traning_loss) b_traning_loss, sum(a_traning_loss) a_traning_loss, sum(male_zb_sum) male_zb_sum, sum(female_zb_sum) female_zb_sum, sum(male_training_sum) male_training_sum, sum(female_training_sum) female_training_sum, sum(male_supplement_sum) male_supplement_sum, sum(female_supplement_sum) female_supplement_sum, sum(male_inqun_sum) male_inqun_sum, sum(female_inqun_sum) female_inqun_sum";

                    string dateRange = ViewBag.dateRange;
                    if (!dateRange.IsNullOrEmpty())
                    {
                        var range = UtilityStatic.CommonHelper.DateRangeFormat(dateRange, 0);
                        where += $" and apply_date >= '{range.date_range_s}' and apply_date < '{range.date_range_e.ToDate().AddDays(1).ToString("yyyy-MM-dd")}'";
                    }

                    var list = DoMySql.FindListBySql<ServiceFactory.JoinNew.v_p_join_new>($"SELECT {feild_sum} FROM (SELECT * FROM p_join_new_data_statistics_yy where {where}) t group by yy_user_sn, yy_name");
                }
                <tr style="background-color: #D9E1F2">
                    <td>合计(@(list.Count)个团队)</td>
                    <td>@(list.Sum(x=>x.zb_sum.ToInt()))</td>
                    <td>@(list.Sum(x=>x.unsupplement_sum.ToInt()))</td>
                    <td>@(list.Sum(x=>x.uninqun_sum.ToInt()))</td>
                    <td>@(list.Sum(x=>x.inqun_sum.ToInt()))</td>
                    <td>@(list.Sum(x=>x.b_allocation_loss.ToInt()))</td>
                    <td>@(list.Sum(x=>x.b_traning_loss.ToInt()))</td>
                    <td>@(list.Sum(x=>x.a_traning_loss.ToInt()))</td>
                    <td>@(list.Sum(x=>x.male_zb_sum.ToInt()))</td>
                    <td>@(list.Sum(x=>x.female_zb_sum.ToInt()))</td>
                    <td>@(list.Sum(x=>x.male_training_sum.ToInt()))</td>
                    <td>@(list.Sum(x=>x.female_training_sum.ToInt()))</td>
                    <td>@(list.Sum(x=>x.male_supplement_sum.ToInt()))</td>
                    <td>@(list.Sum(x=>x.female_supplement_sum.ToInt()))</td>
                    <td>@(list.Sum(x=>x.male_inqun_sum.ToInt()))</td>
                    <td>@(list.Sum(x=>x.female_inqun_sum.ToInt()))</td>
                </tr>
                @foreach (var item in list)
                {
                    <tr>
                        <td>@item.yy_name</td>
                        <td>@item.zb_sum</td>
                        <td>@item.unsupplement_sum</td>
                        <td>@item.uninqun_sum</td>
                        <td>@item.inqun_sum</td>
                        <td>@item.b_allocation_loss</td>
                        <td>@item.b_traning_loss</td>
                        <td>@item.a_traning_loss</td>
                        <td>@item.male_zb_sum</td>
                        <td>@item.female_zb_sum</td>
                        <td>@item.male_training_sum</td>
                        <td>@item.female_training_sum</td>
                        <td>@item.male_supplement_sum</td>
                        <td>@item.female_supplement_sum</td>
                        <td>@item.male_inqun_sum</td>
                        <td>@item.female_inqun_sum</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</body>