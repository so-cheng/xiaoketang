@using System;
@using System.Data;
@using WeiCode.Utility;
@using WeiCode.DataBase;
@using WeiCode.Services;
@using WeiCode.ModelDbs;
@using WeiCode.Domain;
@using Services.Project;
@using WeiCode.Models;

<!-- 页面通用母版 -->
@{
    Layout = ModelBasic.PageModel.GetLayout();
}
<style>
    .layui-table td, .layui-table th, .layui-table-col-set, .layui-table-fixed-r,
    .layui-table-grid-down, .layui-table-header, .layui-table-page, .layui-table-tips-main,
    .layui-table-tool, .layui-table-total, .layui-table-view, .layui-table[lay-skin=line], .layui-table[lay-skin=row] {
        border-color: gray;
    }

    .layui-table th {
        text-align: center;
        font-size: 13px;
    }

    .layui-table td {
        font-size: 13px;
    }

    th, td {
        white-space: nowrap;
    }

    /* 表头固定样式 */
    .layui-table {
        position: relative;
    }

        .layui-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: white;
        }

            .layui-table thead tr:first-child {
                position: sticky;
                top: 0;
                z-index: 11;
                background-color: #FFF3CA;
            }

            .layui-table thead tr:nth-child(2) {
                position: sticky;
                top: 50px; /* 第一行表头的高度 */
                z-index: 11;
                background-color: #FCE4D3;
            }

            /* 确保表头有足够的背景色 */
            .layui-table thead th {
                background-color: inherit;
            }

    .layadmin-header {
        display: none;
        height: 50px;
        line-height: 50px;
        margin-bottom: 0;
        border-radius: 0
    }

        .layadmin-header .layui-breadcrumb {
            padding: 0 15px
        }

    .layui-card-header {
        position: relative
    }

        .layui-card-header .layui-icon {
            line-height: initial;
            position: absolute;
            right: 15px;
            top: 50%;
            margin-top: -7px
        }

    .layuiadmin-card-list {
        padding: 15px
    }

        .layuiadmin-card-list p.layuiadmin-big-font {
            font-size: 36px;
            color: #5f5f5f;
            line-height: 36px;
            padding: 5px 0 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-all;
            white-space: nowrap
        }

        .layuiadmin-card-list p.layuiadmin-normal-font {
            padding-bottom: 10px;
            font-size: 20px;
            color: #5f5f5f;
            line-height: 24px
        }
</style>
@{

}
<!-- 以下书写自己的页面内容代码 -->
<form id="mainForm" class="layui-form" action="DayTarget">
    <div class="layui-row">
        <div class="layui-col-md12">
            <table class="layui-table" style="text-align:center;width:100%;" id="table1" name="table1">
                <thead>
                    <tr style="background-color: #B4C6E7;">
                        <th>团队</th>
                        <th>厅数量</th>
                        <th>提交人数</th>
                        <th>已补人数</th>
                        <th>补人率</th>
                        <th>留人率</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in new ServiceFactory.UserInfo.Yy().GetBaseInfos(new ServiceFactory.UserInfo.Yy.YyBaseInfoFilter()))
                    {
                        <tr>
                            <th>@item.username</th>
                            <th>
                                @(new ServiceFactory.UserInfo.Ting().GetBaseInfos(new ServiceFactory.UserInfo.Ting.TgBaseInfoFilter
                                {
                                    attachUserType = new ServiceFactory.UserInfo.Ting.TgBaseInfoFilter.AttachUserType()
                                    {
                                        userType = ServiceFactory.UserInfo.Ting.TgBaseInfoFilter.AttachUserType.UserType.运营,
                                        UserSn = item.user_sn
                                    }
                                }).Count)
                            </th>
                            <th>@(DoMySql.FindField<ModelDb.p_join_apply>("COALESCE(sum(zb_count), 0)", $"yy_user_sn = '{item.user_sn}' and status <= {ModelDb.p_join_apply.status_enum.已完成.ToSByte()}")[0])</th>
                            <th>@(DoMySql.FindField<ModelDb.p_join_new_info>("count(1)", $"tg_need_id in (select id from p_join_apply where yy_user_sn = '{item.user_sn}' and status <= {ModelDb.p_join_apply.status_enum.已完成.ToSByte()}) and (status = {ModelDb.p_join_new_info.status_enum.等待培训.ToSByte()} or status = {ModelDb.p_join_new_info.status_enum.补人完成.ToSByte()})")[0])</th>
                            <th>@item.attach2</th>
                            <th>@item.attach3</th>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</form>
<script>
    layui.use('form', function () {
        var form = layui.form;
        var layer = layui.layer;
    });
</script>