
@using System.Reflection;

@using System;
@using System.Data;
@using WeiCode.Utility;
@using WeiCode.DataBase;
@using WeiCode.Services;
@using WeiCode.ModelDbs;
@using WeiCode.Domain;
@using Services.Project;
@using WeiCode.Models;
<link rel="stylesheet" href="@UtilityStatic.ConfigHelper.GetConfigString("ResourceUrl")/layui/css/layui.css" media="all">
<link rel="stylesheet" href="@UtilityStatic.ConfigHelper.GetConfigString("ResourceUrl")/layui/css/global.css" media="all" />

<script type="text/javascript" src="@UtilityStatic.ConfigHelper.GetConfigString("ResourceUrl")/layui/layui.js"></script>
<script type="text/javascript" src="@UtilityStatic.ConfigHelper.GetConfigString("ResourceUrl")/layui/common.2.0.js"></script>
<script type="text/javascript" src="@UtilityStatic.ConfigHelper.GetConfigString("ResourceUrl")/jquery/jquery.js"></script>
<script type="text/javascript" src="@UtilityStatic.ConfigHelper.GetConfigString("ResourceUrl")/other/jquery.tablesort.js"></script>

<script type="text/javascript">

    $(function () {
        $('table').tablesort().data('tablesort');
    })
</script>
@{
    Layout = ModelBasic.PageModel.GetLayout();
}
<style>
    .layui-table td, .layui-table th, .layui-table-col-set, .layui-table-fixed-r,
    .layui-table-grid-down, .layui-table-header, .layui-table-page, .layui-table-tips-main,
    .layui-table-tool, .layui-table-total, .layui-table-view, .layui-table[lay-skin=line], .layui-table[lay-skin=row] {
        border-color: gray;
    }

    .layui-table th {
        text-align: center;
        font-weight: 700;
        font-size: 15px;
        border: 1px solid #000 !important;
    }

    .layui-table td {
        font-size: 15px;
        border: 1px solid #000 !important;
    }

    .layui-table {
        border: 1px solid #000 !important;
        border-collapse: collapse !important;
    }
</style>

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>List</title>
</head>
<body>
    <div class="layui-card" style="width:95%;top:30px;margin:0 auto">
        <div class="layui-card" style="width:95%;top:30px;margin:0 auto">
            <div class="layui-card-header">厅管信息完整度排名</div>
                <label style="color:gray">厅管信息是否完整评判规则：抖音号、UID、微信号、男女厅是否未填，密码是否为默认'123456'</label>
         </div>
            <table class="layui-table" style="text-align:center;" id="table" name="table" width="100%">
                <colgroup>
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                </colgroup>
                <thead>
                    <tr style="background-color: #EE8331; font-weight: 700;">
                        <th> 运营</th>
                        <th> 厅管总数</th>
                        <th> 完整信息厅数</th>
                        <th> 缺失信息厅数</th>
                        <th> 完整率</th>

                    </tr>
                    @{
                        var yylist = DoMySql.FindList<ModelDb.user_base>($"user_type_id='{new DomainBasic.UserTypeApp().GetInfoByCode("yyer").id}' and tenant_id='{new DomainBasic.TenantApp().GetInfo().id}'").ToModel<List<ServiceFactory.UserTable.TgInfoRankModel>>();
                        int allTgCount = 0, allCompleteCount = 0, allLackCount = 0;
                        foreach (var item in yylist)
                        {
                            var tglist = new ServiceFactory.UserInfo.Ting().GetBaseInfos(new ServiceFactory.UserInfo.Ting.TgBaseInfoFilter()
                            {
                                attachUserType = new ServiceFactory.UserInfo.Ting.TgBaseInfoFilter.AttachUserType()
                                {
                                    UserSn = item.user_sn,
                                    userType = ServiceFactory.UserInfo.Ting.TgBaseInfoFilter.AttachUserType.UserType.运营
                                }
                            });
                            allTgCount += tglist.Count();
                            item.allCount = tglist.Count();
                            foreach (var tg in tglist)
                            {
                                if (tg.dou_user.IsNullOrEmpty() || tg.manager_wx.IsNullOrEmpty() || tg.dou_UID.IsNullOrEmpty() || tg.tg_sex.IsNullOrEmpty())
                                {
                                    item.lackCount++;
                                    allLackCount++;
                                }
                                else
                                {
                                    item.completeCount++;
                                    allCompleteCount++;
                                }
                            }
                            if (tglist.Count > 0)
                            {
                                item.rank = (item.completeCount.ToDouble() / tglist.Count.ToDouble()).ToDouble() * 100;
                            }
                            else
                            {
                                item.rank = 0.ToDouble() * 100;
                            }
                        }
                        foreach (var item in yylist.OrderByDescending(c => c.rank))
                        {
                            <tr>
                                <th>@item.name</th>
                                <th>一共@(item.allCount)个厅</th>
                                <th>@(item.completeCount)个</th>
                                <th>
                                    <a href="javascript:win_pop_iframe('厅管信息', '/usertable/tginfo/list?yy_user_sn=@(item.user_sn)', 900, 650, '')" class="layui-btn layui-btn-xs">@(item.lackCount)个</a>
                                </th>
                                <th>@item.rank.ToString("0.00")%</th>
                            </tr>
                        }
                        <tr style="background-color: #EE8331; font-weight: 700;">
                            <th>汇总</th>
                            <th>共计@(allTgCount)个厅</th>
                            <th>完整@(allCompleteCount)个</th>
                            <th>缺失@(allLackCount)个</th>
                            <th>平均完整率@(yylist.Count()<=0?"0":(allCompleteCount * 100/ allTgCount).ToString("0.00"))%</th>
                        </tr>
                    }
                </thead>

            </table>

        </div>
</body>
</html>
<script>
    layui.use('form', function () {
        var form = layui.form;
        form.render('select'); // 仅渲染 select 元素
    });
</script>
