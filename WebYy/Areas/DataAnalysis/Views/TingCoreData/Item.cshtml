@using System;
@using WeiCode.Utility;
@using WeiCode.DataBase;
@using WeiCode.Services;
@using WeiCode.ModelDbs;
@using WeiCode.Domain;
@using Services.Project;
@using WeiCode.Models;

@{
    Layout = ModelBasic.PageModel.GetLayout();
}
@{
    string c_date = ViewBag.c_date;
    string c_date_early = c_date.ToDate().AddDays(-1).ToString("yyyy-MM-dd");//前一天
    string c_date_late = c_date.ToDate().AddDays(1).ToString("yyyy-MM-dd");//后一天
}

<style>
    .layui-table td, .layui-table th, .layui-table-col-set, .layui-table-fixed-r,
    .layui-table-grid-down, .layui-table-header, .layui-table-page, .layui-table-tips-main,
    .layui-table-tool, .layui-table-total, .layui-table-view, .layui-table[lay-skin=line], .layui-table[lay-skin=row] {
        border-collapse: collapse;
        border-style: solid;
        border-width: 1px;
        border-color: gray;
    }

    .layui-table th {
        text-align: center;
        font-weight: 700;
        font-size: 13px;
    }

    .layui-table td {
        font-size: 13px;
        text-align: center;
    }

    .layui-table {
        background-color: rgba(30, 144, 255, 0.1);
    }


    /* 表头固定样式 */
    .layui-table {
        position: relative;
    }

        .layui-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: white;
        }

            .layui-table thead tr:first-child {
                position: sticky;
                top: 0;
                z-index: 11;
                background-color: #FFF3CA;
            }

            .layui-table thead tr:nth-child(2) {
                position: sticky;
                top: 28px; /* 第一行表头的高度 */
                z-index: 11;
                background-color: #FCE4D3;
            }

    /* 合并列的背景色 */
    .merge-column {
        background-color: #EAFAF1 !important;
    }
</style>

<div class="layui-card">
    <blockquote class="layui-elem-quote news_search">
        <div class="layui-inline">
            <form class="layui-form">
                <div class="layui-input-inline">
                    <label class="layui-form-label">日期</label>
                </div>

                <div class="layui-inline">
                    <div class="layui-input-inline">
                        @ViewModelBag.Load(Html, new ModelBasic.EmtTimeSelect("c_date")
                   {
                       title = "日期",
                       defaultValue = c_date,
                       mold = ModelBasic.EmtTimeSelect.Mold.date,
                       eventJsChange = new EmtFormBase.EventJsChange
                       {
                           eventJavascript = new EventJavascript
                           {
                               code = "window.location.href = '/DataAnalysis/TingCoreData/Item?c_date=' + page.c_date.value;"
                           },
                       }
                   })
                    </div>
                </div>
                <a href="/DataAnalysis/TingCoreData/Item?c_date=@c_date_early" class="layui-btn">前一天</a>
                <a href="/DataAnalysis/TingCoreData/Item?c_date=@c_date_late" class="layui-btn">后一天</a>
            </form>
        </div>
    </blockquote>

    <div id="tables">
        <div class="table-container">
            <table class="layui-table" style="text-align:center;table-layout: fixed;" name="table">
                <colgroup>
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                </colgroup>
                <thead>
                    <!-- 第一行表头：合并列展示标题 -->
                    <tr>
                        <td colspan="26" style="text-align: center; background-color: #FFF3CA; font-size: 18px; font-weight: 700 ">@(c_date)核心数据指标</td>
                    </tr>
                    <!-- 第二行表头：对应字段 -->
                    <tr style="background-color: #FCE4D3;font-weight:700;">
                        <th>厅管</th>
                        <th>直播厅</th>
                        <th>总人数</th>
                        <th>档位数量</th>
                        <th>开播时长</th>
                        <th>访客数</th>
                        <th>每小时访客数</th>
                        <th>直播推荐占比</th>
                        <th>进入率</th>
                        <th>互动人数</th>
                        <th>付费用户总数</th>
                        <th>新付费用户数</th>
                        <th>平均二消</th>
                        <th>A类用户数</th>
                        <th>B类用户数</th>
                        <th>C类用户数</th>
                        <th>近5天A类用户数</th>
                        <th>近10天A类用户数</th>
                        <th>近15天A类用户数</th>
                        <th>3天内老用户数</th>
                        <th>5天内老用户数</th>
                        <th>7天内老用户数</th>
                        <th>15天内老用户数</th>
                        <th>5天内升A类的用户数</th>
                        <th>总音浪值</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        // 记录上一行的厅管ID，用于判断是否需要合并
                        string prevTgUserSn = "";

                        var dataanalysis_coredata_tings = DoMySql.FindList<ModelDb.dataanalysis_coredata_ting>($"yy_user_sn = '{new UserIdentityBag().user_sn}' and c_date = '{c_date}' and tenant_id = {new DomainBasic.TenantApp().GetInfo().id} order by tg_user_sn");
                        foreach (var item in dataanalysis_coredata_tings)
                        {
                            <tr>
                                <!-- 厅管列合并逻辑：当前厅管与上一行不同时显示并设置合并行数 -->
                                @if (item.tg_user_sn != prevTgUserSn)
                                {

                                    int tgCount = dataanalysis_coredata_tings.Count(x => x.tg_user_sn == item.tg_user_sn);
                                    <td rowspan="@tgCount" class="merge-column">@(new ServiceFactory.UserInfo.Tg().GetTgInfoByUsersn(item.tg_user_sn).name)</td>
                                    prevTgUserSn = item.tg_user_sn;
                                }

                                <!-- 直播厅及数据列 -->
                                <td>@(new ServiceFactory.UserInfo.Ting().GetTingBySn(item.ting_sn).ting_name)</td>
                                <td>@item.zb_count</td>
                                <td>@item.gear</td>
                                <td>@(item.liveHour)小时</td>
                                <td>@item.visitor</td>
                                <td>@item.hourly_visitors</td>
                                <td>@(item.live_rate)%</td>
                                <td>@(item.entry_rate)%</td>
                                <td>@item.interactive_user_count</td>
                                <td>@item.paying_user_total</td>
                                <td>@item.new_paying_user_count</td>
                                <td>@item.avg_second_consumption</td>
                                <td>@item.user_count_type_a</td>
                                <td>@item.user_count_type_b</td>
                                <td>@item.user_count_type_c</td>
                                <td>@item.user_count_type_a_last_5d</td>
                                <td>@item.user_count_type_a_last_10d</td>
                                <td>@item.user_count_type_a_last_15d</td>
                                <td>@item.old_user_count_last_3d</td>
                                <td>@item.old_user_count_last_5d</td>
                                <td>@item.old_user_count_last_7d</td>
                                <td>@item.old_user_count_last_15d</td>
                                <td>@item.upgraded_to_a_count_last_5d</td>
                                <td>@item.totalFanTickets</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
