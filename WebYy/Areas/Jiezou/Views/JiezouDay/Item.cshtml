@using System;
@using System.Data;
@using WeiCode.Utility;
@using WeiCode.DataBase;
@using WeiCode.Services;
@using WeiCode.ModelDbs;
@using WeiCode.Domain;
@using Services.Project;
@using WeiCode.Models;

<!-- 页面通用母版 -->
@{
    Layout = ModelBasic.PageModel.GetLayout();
}
@{
    string yy_user_sn = ViewBag.yy_user_sn;

    //默认日期前一天
    string c_date = ViewBag.c_date;
    if (c_date.IsNullOrEmpty())
    {
        c_date = DateTime.Today.AddDays(-1).ToString("yyyy-MM-dd");
    }
    var c_date_early = c_date.ToDate().AddDays(-1).ToString("yyyy-MM-dd");//前一天
    var c_date_late = c_date.ToDate().AddDays(1).ToString("yyyy-MM-dd");//后一天


    // 构建基础查询条件
    string where = $"data_time = '{c_date}' AND tenant_id = '{new DomainBasic.TenantApp().GetInfo().id}'";
    string yy_user_sn_in = "";

    if (ViewBag.yy_user_sn != null)
    {
        var yy_arr = ViewBag.yy_user_sn.Split(',');
        foreach (var yy_sn in yy_arr)
        {

            yy_user_sn_in += $"'{yy_sn}',";

        }
        // 移除最后一个逗号
        yy_user_sn_in = yy_user_sn_in.TrimEnd(',');
    }

    // 只有当拼接后的条件不为空时才添加IN子句
    if (!string.IsNullOrEmpty(yy_user_sn_in))
    {
        where += $" AND yy_user_sn IN ({yy_user_sn_in})";
    }

    var tableList = DoMySql.FindList<ModelDb.jiezou_detail>(where + $"order by yy_user_sn");
}


<style>
    .layui-table td, .layui-table th, .layui-table-col-set, .layui-table-fixed-r,
    .layui-table-grid-down, .layui-table-header, .layui-table-page, .layui-table-tips-main,
    .layui-table-tool, .layui-table-total, .layui-table-view, .layui-table[lay-skin=line], .layui-table[lay-skin=row] {
        border-color: gray;
    }

    .layui-table th {
        text-align: center;
        font-weight: 700;
        font-size: 13px;
    }

    .layui-table td {
        font-size: 13px;
    }

    th, td {
        white-space: nowrap;
    }
    /* 表头固定样式 */
    .layui-table {
        position: relative;
    }

        .layui-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: white;
        }

            .layui-table thead tr:first-child {
                position: sticky;
                top: 0;
                z-index: 11;
                background-color: #FFF3CA;
            }

            .layui-table thead tr:nth-child(2) {
                position: sticky;
                top: 28px; /* 第一行表头的高度 */
                z-index: 11;
                background-color: #FCE4D3;
            }

            /* 确保表头有足够的背景色 */
            .layui-table thead th {
                background-color: inherit;
            }
</style>
<form class="layui-form" method="get">
    <div class="layui-input-inline">
        <label class="layui-form-label">日期</label>
    </div>
    <div class="layui-inline">
        <div class="layui-input-inline">
            @ViewModelBag.Load(Html, new ModelBasic.EmtTimeSelect("c_date")
           {
               title = "日期",
               defaultValue = c_date,
               mold = ModelBasic.EmtTimeSelect.Mold.date,
               eventJsChange = new EmtFormBase.EventJsChange
               {
                   eventJavascript = new EventJavascript
                   {
                       code = @"window.location.href = '/jiezou/JiezouDay/item?c_date=' + page.c_date.value + '&yy_user_sn=' + $(""[name = 'yy_user_sn']"").val();"
                   },
               }
           })
        </div>
    </div>


    <a href="/jiezou/JiezouDay/item?c_date=@c_date_early&yy_user_sn=@ViewBag.yy_user_sn" class="layui-btn">前一天</a>
    <a href="/jiezou/JiezouDay/item?c_date=@c_date_late&yy_user_sn=@ViewBag.yy_user_sn" class="layui-btn">后一天</a>

    <div class="layui-input-inline">
        <label class="layui-form-label">关联运营</label>
    </div>
    <div class="layui-inline">
        <div class="layui-input-inline">
            @ViewModelBag.Load(Html, new ModelBasic.EmtExt.XmSelect("yy_user_sn")
       {
           width = "300px",
           title = "关联运营",
           options = new ServiceFactory.UserInfo.Yy().GetWithYyForKv(new UserIdentityBag().user_sn),
           defaultValue = ViewBag.yy_user_sn,
       })
        </div>
    </div>
    <button type="submit" class="layui-btn">查询</button>
</form>


<div style="text-align:right;">
    <a href="javascript:win_pop_iframe('编辑阶段规则', '/jiezou/JiezouDay/RuleChange', window.innerWidth * 0.8, window.innerHeight * 0.8);" class="layui-btn layui-bg-blue">编辑阶段规则</a>
</div>
<form id="mainForm" class="layui-form" action="">

    <div class="layui-row">
        <div class="layui-col-md12">
            <table class="layui-table" style="text-align:center;width:100%;" id="table1" name="table1">
                <colgroup>
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                </colgroup>
                <thead>
                    <tr>
                        <th colspan="7" style="text-align: center; background-color: #FFF3CA; font-size: 18px; font-weight: 700 ">
                            节奏展示
                            <a style="color:blue;font-size:17px;" href="javascript:win_pop_iframe('阶段规则说明', '/jiezou/JiezouDay/RuleDefinition', 800,800);">阶段规则说明</a>
                        </th>
                    </tr>
                    <tr>
                        <th style="background-color:#FFF2CC">所属运营</th>
                        <th style="background-color:#FFF2CC">厅管</th>
                        <th style="background-color:#FFF2CC">厅名</th>
                        <th style="background-color:#FFF2CC">当前阶段</th>
                        <th style="background-color:#FFF2CC ">节奏展示</th>
                    </tr>
                </thead>

                @{ string yy = "";
                    var TingCount = tableList.Count;  //总厅数
                    decimal passCount = 0;//达标数
                    decimal failCount = 0;//未达标数
                    decimal PassRate = 0;//达标率

                    foreach (var item in tableList)
                    {
                        var ting = new ServiceFactory.UserInfo.Ting().GetTingBySn(item.ting_sn);
                        if (item.step >= 4.0m)
                        {
                            passCount++; // 达标计数
                        }
                        else
                        {
                            failCount++; // 不达标计数（包括空值、小于4.0的值）
                        }
                        <tr>
                            @if (item.yy_user_sn != yy)
                            {
                                <td rowspan="@(tableList.FindAll(x=>x.yy_user_sn==item.yy_user_sn).Count)" style="background-color:#EAFAF1">@(new ServiceFactory.UserInfo.Yy().GetInfoByUserSn(item.yy_user_sn).username)</td>
                            }
                            <td style="background-color:#EAFAF1">
                                @(new ServiceFactory.UserInfo.Tg().GetTgInfoByUsersn(item.tg_user_sn).name)
                            </td>
                            <td style="background-color:#EAFAF1">@(ting.ting_name)</td>
                            <td style="background-color:#EAFAF1">@(item.step)</td>
                            <td style="background-color:#EAFAF1">
                                <div style="text-align:center;">
                                    <a href="javascript: win_pop_iframe('节奏展示', '/jiezou/JiezouDay/Detail?ting_sn=' + ('@item.ting_sn'), window.innerWidth * 0.8, window.innerHeight * 0.8);" class="layui-btn layui-btn-xs layui-bg-blue">查看历史节奏</a>
                                </div>
                            </td>

                        </tr>
                        yy = item.yy_user_sn;
                    }
                    if (tableList.Count == 0)
                    {
                        PassRate = 0;
                    }
                    else
                    {
                        PassRate = Decimal.Round(passCount / (decimal)tableList.Count * 100, 2);//达标率
                    }
                    <tr>
                        <th colspan="4" style="background-color:#FFE9E8">当日达标数</th>
                        <th style="background-color:#FFE9E8 ">@passCount</th>
                    </tr>
                    <tr>
                        <th colspan="4" style="background-color:#FFE9E8">当日未达标数</th>
                        <th style="background-color:#FFE9E8 ">@failCount</th>
                    </tr>
                    <tr>
                        <th colspan="4" style="background-color:#FFE9E8">当日总厅数</th>
                        <th style="background-color:#FFE9E8 ">@tableList.Count</th>
                    </tr>
                    <tr>
                        <th colspan="4" style="background-color:#FFE9E8">当日达标率</th>
                        <th style="background-color:#FFE9E8 ">@(PassRate)%</th>
                    </tr>
                }
            </table>

        </div>
    </div>
</form>