@using System;
@using System.Data;
@using System.Collections.Generic;
@using WeiCode.Utility;
@using WeiCode.DataBase;
@using WeiCode.Services;
@using WeiCode.ModelDbs;
@using WeiCode.Domain;
@using Services.Project;
@using WeiCode.Models;

<!-- 页面通用母版 -->
@{
    Layout = ModelBasic.PageModel.GetLayout();
}
@{  // 默认为近半个月
    string c_date = ViewBag.c_date;
    if (c_date.IsNullOrEmpty())
    {
        c_date = DateTime.Today.AddDays(-16).ToString("yyyy-MM-dd") + " ~ " + DateTime.Today.AddDays(-1).ToString("yyyy-MM-dd");
    }

    // 解析开始结束时间
    var date_s = c_date.Split('~');
    DateTime f_date = date_s[0].Trim().ToDate();
    DateTime t_date = date_s[1].Trim().ToDate();

    // 补全时间段内日期
    List<string> dateArray = new List<string>();
    List<int> passCountList = new List<int>();

    for (DateTime date = f_date; date <= t_date; date = date.AddDays(1))
    {
        string currentDate = date.ToString("yyyy-MM-dd");
        dateArray.Add(currentDate);

        // 查询当天的通过数量(step>=4)
        var dailyPassCount = DoMySql.FindListBySql<ModelDb.jiezou_detail>(
            $"select * from jiezou_detail where step>=4 and data_time >= '{currentDate}' and data_time < '{date.AddDays(1).ToString("yyyy-MM-dd")}'").Count;

        passCountList.Add(dailyPassCount);
    }
}

<style>
    .layui-table td, .layui-table th, .layui-table-col-set, .layui-table-fixed-r,
    .layui-table-grid-down, .layui-table-header, .layui-table-page, .layui-table-tips-main,
    .layui-table-tool, .layui-table-total, .layui-table-view, .layui-table[lay-skin=line], .layui-table[lay-skin=row] {
        border-color: gray;
    }

    .layui-table th {
        text-align: center;
        font-weight: 700;
        font-size: 13px;
    }

    .layui-table td {
        font-size: 13px;
    }

    th, td {
        white-space: nowrap;
    }

    .date-filter {
        margin: 15px 0;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
    }

        .date-filter .layui-form-label {
            margin-right: 10px;
            font-weight: 600;
        }

    #main_line {
        width: 100%;
        height: 450px;
        margin: 20px 0;
        border: 1px solid #eee;
        border-radius: 4px;
        padding: 10px;
        box-sizing: border-box;
    }
</style>

<div class="date-filter">
    <div class="layui-form-label">日期范围</div>
    <div class="layui-input-inline" style="width: 300px;">
        @ViewModelBag.Load(Html, new ModelBasic.EmtTimeSelect("c_date", true)
        {
            title = "日期",
            defaultValue = c_date,
            mold = ModelBasic.EmtTimeSelect.Mold.date_range,
            eventJsChange = new EmtFormBase.EventJsChange
            {
                eventJavascript = new EventJavascript
                {
                    code = $"window.location.href = '/jiezou/JiezouDay/Detail?c_date=' + page.c_date.value + ';"
                },
            }
        })
    </div>
</div>

<div id="main_line"></div>

<script src="@UtilityStatic.ConfigHelper.GetConfigString("ResourceUrl")/other/echarts.min.4.3.0.js"></script>

<script type="text/javascript">
    // 基于准备好的dom，初始化echarts实例
    var myChart = echarts.init(document.getElementById('main_line'));

    // 处理数据
    var dateArray = @Html.Raw(Json.Encode(dateArray));
    var passCountList = @Html.Raw(Json.Encode(passCountList)); //达标数量曲线

    // 图表配置
    var option = {
        title: {
            text: ' 每日达标数量趋势图',
            left: 'center',
            textStyle: {
                fontSize: 16,
                fontWeight: 'normal'
            },
            padding: [10, 0, 20, 0]
        },
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            borderColor: '#ddd',
            borderWidth: 1,
            textStyle: { color: '#333' },
            formatter: function(params) {
                var param = params[0];
                return '<div style="font-weight:bold;margin-bottom:5px;">' + param.name + '</div>' +
                       '<div><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background-color:' + param.color + ';margin-right:5px;"></span>' +
                       param.seriesName + ': ' + param.value + '</div>';
            }
        },
        legend: {
            data: ['通过数量'],
            selected: {
                '通过数量': true
            },
            top: 30,
            left: 'center',
            textStyle: {
                fontSize: 12
            }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: dateArray,
            axisLine: {
                lineStyle: {
                    color: '#ccc'
                }
            },
            axisTick: {
                alignWithLabel: true
            },
            axisLabel: {
                interval: 0,
                rotate: 45,
                fontSize: 12
            },
            splitLine: {
                show: true,
                lineStyle: {
                    color: '#f5f5f5'
                }
            }
        },
        yAxis: {
            type: 'value',
            name: '通过数量',
            axisLine: {
                show: false
            },
            axisLabel: {
                fontSize: 12,
                formatter: '{value}'
            },
            splitLine: {
                lineStyle: {
                    color: '#f5f5f5'
                }
            }
        },
        series: [
            {
                name: '通过数量',
                type: 'line',
                data: passCountList,
                symbol: 'circle',
                symbolSize: 6,
                smooth: true,
                lineStyle: {
                    width: 2,
                    color: '#5470c6'
                },
                itemStyle: {
                    color: '#5470c6'
                },
                areaStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        { offset: 0, color: 'rgba(84, 112, 198, 0.3)' },
                        { offset: 1, color: 'rgba(84, 112, 198, 0)' }
                    ])
                },
                emphasis: {
                    scale: true,
                    itemStyle: {
                        shadowBlur: 10,
                        shadowColor: 'rgba(0, 0, 0, 0.3)'
                    }
                }
            }
        ]
    };

    // 使用刚指定的配置项和数据显示图表
    myChart.setOption(option);

    // 响应窗口大小变化，重绘图表
    window.addEventListener('resize', function() {
        myChart.resize();
    });
</script>
