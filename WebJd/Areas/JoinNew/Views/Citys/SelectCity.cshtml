@using System;
@using System.Data;
@using WeiCode.Utility;
@using WeiCode.DataBase;
@using WeiCode.Services;
@using WeiCode.ModelDbs;
@using WeiCode.Domain;
@using Services.Project;
@using WeiCode.Models;

@{
    
}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>城市选择</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: white;
            height: 100vh;
            overflow: hidden;
        }

        .panel-content {
            padding: 20px;
            height: 560px;
            overflow-y: auto;
        }

        .province-group {
            margin-bottom: 25px;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            overflow: hidden;
        }

        .province-header {
            background: #f8f9fa;
            padding: 15px 20px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }

            .province-header:hover {
                background: #e9ecef;
            }

            .province-header.active {
                background: #667eea;
                color: white;
            }

        .toggle-icon {
            transition: transform 0.3s ease;
        }

        .province-header.active .toggle-icon {
            transform: rotate(180deg);
        }

        .city-list {
            padding: 0 20px 20px;
            display: none;
        }

            .city-list.show {
                display: block;
            }

        .city-item {
            display: inline-block;
            margin: 8px 15px 8px 0;
        }

        .city-checkbox {
            display: none;
        }

        .city-label {
            display: inline-block;
            padding: 8px 16px;
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            color: #666;
        }

            .city-label:hover {
                background: #e9ecef;
                border-color: #667eea;
            }

        .city-checkbox:checked + .city-label {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .panel-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            border-top: 1px solid #e1e5e9;
            background: white;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

            .btn-secondary:hover {
                background: #5a6268;
            }

        .btn-primary {
            background: #667eea;
            color: white;
        }

            .btn-primary:hover {
                background: #5a6fd8;
            }

        .region-group h4 {
            margin: 20px 0 15px 0;
            color: #667eea;
            font-size: 16px;
        }

        .province-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

            .province-checkbox:indeterminate {
                background-color: #667eea;
                border-color: #667eea;
            }
    </style>
</head>
<body>
    <div class="panel-content" id="panelContent">
        <!-- 省份和城市将通过JavaScript动态生成 -->
    </div>

    <div class="panel-footer">
        <button class="btn btn-secondary" id="cancelBtn">取消</button>
        <button class="btn btn-primary" id="confirmBtn">确定</button>
    </div>

    <script>
        // 城市数据
        const cityData = {
            '华北地区': {
                '北京': ['东城区', '西城区', '朝阳区', '丰台区', '石景山区', '海淀区', '门头沟区', '房山区', '通州区', '顺义区', '昌平区', '大兴区', '怀柔区', '平谷区', '密云区', '延庆区'],
                '天津': ['和平区', '河东区', '河西区', '南开区', '河北区', '红桥区', '东丽区', '西青区', '津南区', '北辰区', '武清区', '宝坻区', '滨海新区', '宁河区', '静海区', '蓟州区'],
                '河北': ['石家庄', '唐山', '秦皇岛', '邯郸', '邢台', '保定', '张家口', '承德', '沧州', '廊坊', '衡水'],
                '山西': ['太原', '大同', '阳泉', '长治', '晋城', '朔州', '晋中', '运城', '忻州', '临汾', '吕梁'],
                '内蒙古': ['呼和浩特', '包头', '乌海', '赤峰', '通辽', '鄂尔多斯', '呼伦贝尔', '巴彦淖尔', '乌兰察布', '兴安盟', '锡林郭勒盟', '阿拉善盟']
            },
            '东北地区': {
                '辽宁': ['沈阳', '大连', '鞍山', '抚顺', '本溪', '丹东', '锦州', '营口', '阜新', '辽阳', '盘锦', '铁岭', '朝阳', '葫芦岛'],
                '吉林': ['长春', '吉林', '四平', '辽源', '通化', '白山', '松原', '白城', '延边朝鲜族自治州'],
                '黑龙江': ['哈尔滨', '齐齐哈尔', '鸡西', '鹤岗', '双鸭山', '大庆', '伊春', '佳木斯', '七台河', '牡丹江', '黑河', '绥化', '大兴安岭地区']
            },
            '华东地区': {
                '上海': ['黄浦区', '徐汇区', '长宁区', '静安区', '普陀区', '虹口区', '杨浦区', '闵行区', '宝山区', '嘉定区', '浦东新区', '金山区', '松江区', '青浦区', '奉贤区', '崇明区'],
                '江苏': ['南京', '无锡', '徐州', '常州', '苏州', '南通', '连云港', '淮安', '盐城', '扬州', '镇江', '泰州', '宿迁'],
                '浙江': ['杭州', '宁波', '温州', '嘉兴', '湖州', '绍兴', '金华', '衢州', '舟山', '台州', '丽水'],
                '安徽': ['合肥', '芜湖', '蚌埠', '淮南', '马鞍山', '淮北', '铜陵', '安庆', '黄山', '滁州', '阜阳', '宿州', '六安', '亳州', '池州', '宣城'],
                '福建': ['福州', '厦门', '莆田', '三明', '泉州', '漳州', '南平', '龙岩', '宁德'],
                '江西': ['南昌', '景德镇', '萍乡', '九江', '新余', '鹰潭', '赣州', '吉安', '宜春', '抚州', '上饶'],
                '山东': ['济南', '青岛', '淄博', '枣庄', '东营', '烟台', '潍坊', '济宁', '泰安', '威海', '日照', '莱芜', '临沂', '德州', '聊城', '滨州', '菏泽']
            },
            '华中地区': {
                '河南': ['郑州', '开封', '洛阳', '平顶山', '安阳', '鹤壁', '新乡', '焦作', '濮阳', '许昌', '漯河', '三门峡', '南阳', '商丘', '信阳', '周口', '驻马店', '济源'],
                '湖北': ['武汉', '黄石', '十堰', '宜昌', '襄阳', '鄂州', '荆门', '孝感', '荆州', '黄冈', '咸宁', '随州', '恩施土家族苗族自治州'],
                '湖南': ['长沙', '株洲', '湘潭', '衡阳', '邵阳', '岳阳', '常德', '张家界', '益阳', '郴州', '永州', '怀化', '娄底', '湘西土家族苗族自治州']
            },
            '华南地区': {
                '广东': ['广州', '韶关', '深圳', '珠海', '汕头', '佛山', '江门', '湛江', '茂名', '肇庆', '惠州', '梅州', '汕尾', '河源', '阳江', '清远', '东莞', '中山', '潮州', '揭阳', '云浮'],
                '广西': ['南宁', '柳州', '桂林', '梧州', '北海', '防城港', '钦州', '贵港', '玉林', '百色', '贺州', '河池', '来宾', '崇左'],
                '海南': ['海口', '三亚', '三沙', '儋州'],
                '香港': ['中西区', '湾仔区', '东区', '南区', '油尖旺区', '深水埗区', '九龙城区', '黄大仙区', '观塘区', '荃湾区', '屯门区', '元朗区', '北区', '大埔区', '西贡区', '沙田区', '葵青区', '离岛区'],
                '澳门': ['花地玛堂区', '花王堂区', '望德堂区', '大堂区', '风顺堂区', '嘉模堂区', '路氹城', '圣方济各堂区', '氹仔', '路环']
            },
            '西南地区': {
                '重庆': ['渝中区', '大渡口区', '江北区', '沙坪坝区', '九龙坡区', '南岸区', '北碚区', '渝北区', '巴南区', '涪陵区', '綦江区', '大足区', '璧山区', '铜梁区', '潼南区', '荣昌区', '永川区', '江津区', '合川区', '南川区', '长寿区', '梁平区', '城口县', '丰都县', '垫江县', '武隆区', '忠县', '开州区', '云阳县', '奉节县', '巫山县', '巫溪县', '石柱土家族自治县', '秀山土家族苗族自治县', '酉阳土家族苗族自治县', '彭水苗族土家族自治县'],
                '四川': ['成都', '自贡', '攀枝花', '泸州', '德阳', '绵阳', '广元', '遂宁', '内江', '乐山', '南充', '眉山', '宜宾', '广安', '达州', '雅安', '巴中', '资阳', '阿坝藏族羌族自治州', '甘孜藏族自治州', '凉山彝族自治州'],
                '贵州': ['贵阳', '六盘水', '遵义', '安顺', '毕节', '铜仁', '黔西南布依族苗族自治州', '黔东南苗族侗族自治州', '黔南布依族苗族自治州'],
                '云南': ['昆明', '曲靖', '玉溪', '保山', '昭通', '丽江', '普洱', '临沧', '楚雄彝族自治州', '红河哈尼族彝族自治州', '文山壮族苗族自治州', '西双版纳傣族自治州', '大理白族自治州', '德宏傣族景颇族自治州', '怒江傈僳族自治州', '迪庆藏族自治州'],
                '西藏': ['拉萨', '日喀则', '昌都', '林芝', '山南', '那曲', '阿里地区']
            },
            '西北地区': {
                '陕西': ['西安', '铜川', '宝鸡', '咸阳', '渭南', '延安', '汉中', '榆林', '安康', '商洛'],
                '甘肃': ['兰州', '嘉峪关', '金昌', '白银', '天水', '武威', '张掖', '平凉', '酒泉', '庆阳', '定西', '陇南', '临夏回族自治州', '甘南藏族自治州'],
                '青海': ['西宁', '海东', '海北藏族自治州', '黄南藏族自治州', '海南藏族自治州', '果洛藏族自治州', '玉树藏族自治州', '海西蒙古族藏族自治州'],
                '宁夏': ['银川', '石嘴山', '吴忠', '固原', '中卫'],
                '新疆': ['乌鲁木齐', '克拉玛依', '吐鲁番', '哈密', '昌吉回族自治州', '博尔塔拉蒙古自治州', '巴音郭楞蒙古自治州', '阿克苏地区', '克孜勒苏柯尔克孜自治州', '喀什地区', '和田地区', '伊犁哈萨克自治州', '塔城地区', '阿勒泰地区', '石河子', '阿拉尔', '图木舒克', '五家渠', '北屯', '铁门关', '双河', '可克达拉', '昆玉', '胡杨河']
            }
        };

        // 选中的城市
        let selectedCities = new Set();

        // DOM元素
        const panelContent = document.getElementById('panelContent');
        const cancelBtn = document.getElementById('cancelBtn');
        const confirmBtn = document.getElementById('confirmBtn');

        // 更新省份复选框状态
        function updateProvinceCheckboxState(provinceCheckbox, cityCheckboxes) {
            const checkedCities = Array.from(cityCheckboxes).filter(checkbox => checkbox.checked);
            const totalCities = cityCheckboxes.length;

            if (checkedCities.length === 0) {
                // 没有城市被选中
                provinceCheckbox.checked = false;
                provinceCheckbox.indeterminate = false;
            } else if (checkedCities.length === totalCities) {
                // 所有城市都被选中
                provinceCheckbox.checked = true;
                provinceCheckbox.indeterminate = false;
            } else {
                // 部分城市被选中
                provinceCheckbox.checked = false;
                provinceCheckbox.indeterminate = true;
            }
        }

        // 初始化城市面板
        function initCityPanel() {
            panelContent.innerHTML = '';

            Object.entries(cityData).forEach(([region, provinces]) => {
                const regionDiv = document.createElement('div');
                regionDiv.className = 'region-group';
                regionDiv.innerHTML = `<h4>${region}</h4>`;

                Object.entries(provinces).forEach(([province, cities]) => {
                    const provinceDiv = document.createElement('div');
                    provinceDiv.className = 'province-group';

                    const provinceHeader = document.createElement('div');
                    provinceHeader.className = 'province-header';
                    provinceHeader.innerHTML = `
                             <div style="display: flex; align-items: center; gap: 10px;">
                                 <input type="checkbox" class="province-checkbox" id="province_${province}" style="margin: 0;">
                                 <span>${province}</span>
                             </div>
                             <span class="toggle-icon">▼</span>
                         `;

                    const cityList = document.createElement('div');
                    cityList.className = 'city-list';

                    // 检查该省份是否包含选中的城市
                    const hasSelectedCities = cities.some(city => selectedCities.has(city));

                    cities.forEach(city => {
                        const cityItem = document.createElement('div');
                        cityItem.className = 'city-item';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'city-checkbox';
                        checkbox.id = `city_${province}_${city}`;
                        checkbox.value = city;

                        const label = document.createElement('label');
                        label.className = 'city-label';
                        label.htmlFor = `city_${province}_${city}`;
                        label.textContent = city;

                        // 如果城市已被选中，设置复选框为选中状态
                        if (selectedCities.has(city)) {
                            checkbox.checked = true;
                        }

                        cityItem.appendChild(checkbox);
                        cityItem.appendChild(label);
                        cityList.appendChild(cityItem);
                    });

                    provinceDiv.appendChild(provinceHeader);
                    provinceDiv.appendChild(cityList);
                    regionDiv.appendChild(provinceDiv);

                    // 获取省份复选框元素
                    const provinceCheckbox = provinceHeader.querySelector('.province-checkbox');

                    // 省份展开/收起功能（点击省份名称或箭头时）
                    const toggleProvince = (e) => {
                        // 如果点击的是复选框，不触发展开/收起
                        if (e.target.type === 'checkbox') {
                            return;
                        }
                        provinceHeader.classList.toggle('active');
                        cityList.classList.toggle('show');
                    };

                    // 省份名称和箭头的点击事件
                    provinceHeader.querySelector('div span').addEventListener('click', toggleProvince);
                    provinceHeader.querySelector('.toggle-icon').addEventListener('click', toggleProvince);

                    // 省份全选/取消全选功能
                    provinceCheckbox.addEventListener('change', (e) => {
                        const isChecked = e.target.checked;
                        const cityCheckboxes = cityList.querySelectorAll('.city-checkbox');

                        cityCheckboxes.forEach(checkbox => {
                            checkbox.checked = isChecked;
                            if (isChecked) {
                                selectedCities.add(checkbox.value);
                            } else {
                                selectedCities.delete(checkbox.value);
                            }
                        });

                        // 更新省份复选框状态
                        updateProvinceCheckboxState(provinceCheckbox, cityCheckboxes);
                    });

                    // 城市复选框变化时更新省份复选框状态
                    cityList.addEventListener('change', (e) => {
                        if (e.target.type === 'checkbox') {
                            updateProvinceCheckboxState(provinceCheckbox, cityList.querySelectorAll('.city-checkbox'));
                        }
                    });

                    // 如果该省份包含选中的城市，自动展开
                    if (hasSelectedCities) {
                        provinceHeader.classList.add('active');
                        cityList.classList.add('show');
                    }

                    // 初始化省份复选框状态
                    updateProvinceCheckboxState(provinceCheckbox, cityList.querySelectorAll('.city-checkbox'));
                });

                panelContent.appendChild(regionDiv);
            });
        }

        // 确认选择
        function confirmSelection() {
            // 获取所有选中的城市
            const checkedBoxes = document.querySelectorAll('.city-checkbox:checked');
            const cities = Array.from(checkedBoxes).map(checkbox => checkbox.value);

            // 向父页面发送消息
            parent.page_post.name.val(cities);
            // 关闭弹窗
            var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
            parent.layer.close(index);
        }

        // 取消选择
        function cancelSelection() {
            // 关闭弹窗
            var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
            parent.layer.close(index);
        }

        // 事件监听
        cancelBtn.addEventListener('click', cancelSelection);
        confirmBtn.addEventListener('click', confirmSelection);

        // 初始化
        initCityPanel();
    </script>
</body>
</html>
