
@{
    Layout = null;
}

@using WeiCode.Utility;
@using WeiCode.DataBase;
@using WeiCode.Services;
@using WeiCode.ModelDbs;
@using WeiCode.Domain;
@using WeiCode.Domain.Basic;

@{
    var user_type_name = DoMySql.FindEntity<ModelDbBasic.user_type>($"id = '{new DomainBasic.TenantDomainApp().GetInfo().user_type_id}'", false).name;
    var sys_role = DoMySql.FindEntity<ModelDbBasic.sys_role>($"id = '{new UserIdentityBag().cur_role_id}'", false);
    var sys_position = DoMySql.FindEntity<ModelDbBasic.sys_position>($"id = '{new UserIdentityBag().cur_position_id}'", false);
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>工作台-@user_type_name</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    @if (!new DomainBasic.ModularFunctionApp().GetParaBool(new ModularAuthorize().getName(), "后台框架", "偏好设置") || new DomainBasic.ModularConfigApp().GetFunctionContent(new ModularAuthorize().getName(), "后台框架-偏好设置", "手机浏览") != "允许缩放")
    {
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    }
    <link href="@UtilityStatic.ConfigHelper.GetConfigString("ResourceUrl")/layui/css/layui.css" rel="stylesheet" />
    <link rel="stylesheet" href="/Assets/layui/layuiadmin/style/admin.css" media="all">
    <link rel="stylesheet" href="http://121.40.186.72:8066/bootstrap/icons/bootstrap-icons.css">
    <style>
        body {
            margin: 0;
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background: #f5f6fa;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 200px;
            background: linear-gradient(180deg, #eaf3ff 0%, #f5faff 100%);
            border-right: 1px solid #e6e6e6;
            z-index: 10;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            box-shadow: none;
            display: block;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            height: 56px;
            padding: 0 16px;
            border-bottom: 1px solid #f0f0f0;
            margin-bottom: 8px;
        }

        .logo-img {
            width: 32px;
            height: 32px;
            margin-right: 8px;
        }

        .logo-title {
            font-size: 16px;
            font-weight: bold;
            color: #222;
        }

        .sidebar-section {
            flex: 1 1 auto;
            overflow-y: auto;
            min-height: 0;
            /* 兼容性写法，防止溢出 */
            max-height: calc(100vh - 56px - 40px);
        }

        .sidebar-section-title {
            font-size: 13px;
            color: #999;
            padding: 12px 0 4px 24px;
            letter-spacing: 1px;
        }

        .sidebar-menu-group {
            margin-bottom: 4px;
        }

        .sidebar-menu-item {
            padding: 8px 0 8px 24px;
            font-size: 15px;
            color: #333;
            display: flex;
            align-items: center;
            cursor: pointer;
            border-radius: 4px 0 0 4px;
            position: relative;
            transition: background 0.2s;
        }

            .sidebar-menu-item .icon {
                margin-right: 8px;
                font-size: 16px;
                color: #666;
            }

            .sidebar-menu-item.active, .sidebar-menu-item:hover {
                background: #f0f6ff;
                color: #1890ff;
            }

                .sidebar-menu-item.active .icon, .sidebar-menu-item:hover .icon {
                    color: #1890ff;
                }

        .sidebar-submenu {
            margin-left: 24px;
            margin-top: 4px;
            display: flex;
            flex-direction: column;
        }

        .sidebar-submenu-item {
            font-size: 13px;
            color: #666;
            padding: 4px 0 4px 24px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }

            .sidebar-submenu-item.active, .sidebar-submenu-item:hover {
                background: #e6f7ff;
                color: #1890ff;
            }

        .sidebar-footer {
            padding: 12px 0 12px 24px;
            font-size: 14px;
            color: #888;
            border-top: 1px solid #f0f0f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        /* 滚动条美化 */
        .sidebar-section::-webkit-scrollbar {
            width: 6px;
            background: #f5f6fa;
        }

        .sidebar-section::-webkit-scrollbar-thumb {
            background: #e6e6e6;
            border-radius: 3px;
        }

        .header {
            position: fixed;
            left: 200px;
            right: 0;
            top: 0;
            height: 56px;
            background: linear-gradient(90deg, #eaf3ff 0%, #f5f6fa 100%);
            border-bottom: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px 0 0;
            z-index: 20;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.03);
        }

        .header-left {
            display: flex;
            align-items: center;
            height: 56px;
            margin-left: 0;
        }



        .header-nav-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-left: 24px;
        }

        .nav-control-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: #f3f6fb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #555;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            outline: none;
        }

            .nav-control-btn:hover {
                background: #eaf3ff;
                color: #204a8c;
                transform: translateY(-1px);
            }

            .nav-control-btn:active {
                transform: translateY(0);
            }

        .sidebar.collapsed {
            transform: translateX(-200px);
        }

        .header.sidebar-collapsed {
            left: 0;
        }

        .main.sidebar-collapsed {
            margin-left: 20px;
        }

        .layadmin-pagetabs.sidebar-collapsed,
        .layui-layout-admin .layui-body.sidebar-collapsed {
            left: 0;
        }

        /* 当侧边栏隐藏时，iframe框架占满全屏 */
        .layui-body.sidebar-collapsed {
            left: 0 !important;
            width: 100% !important;
        }

        .layadmin-pagetabs.sidebar-collapsed {
            left: 0 !important;
            width: 100% !important;
        }

        /* 确保iframe内容区域也能正确响应 */
        .layadmin-tabsbody-item.sidebar-collapsed {
            width: 100% !important;
        }

        .layadmin-iframe.sidebar-collapsed {
            width: 100% !important;
        }

        .header-logo {
            width: 32px;
            height: 32px;
            margin: 0 12px 0 0;
        }

        .header-title {
            font-size: 18px;
            font-weight: bold;
            color: #222;
            margin-right: 24px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .header-icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f3f6fb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #555;
            margin-right: 4px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

            .header-icon-btn:hover {
                background: #eaf3ff;
                color: #204a8c;
            }

        .header-badge {
            position: absolute;
            top: 1px;
            right: -11px;
            min-width: 16px;
            height: 16px;
            background: #ff3c3c;
            color: #fff;
            font-size: 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            font-weight: bold;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #4a8cff;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }

        .header-user-info {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }

        .header-user-name {
            font-size: 14px;
            color: #222;
            font-weight: bold;
        }

        .header-user-role {
            font-size: 12px;
            color: #8fa4c3;
        }

        .header-tabs-wrapper {
            position: fixed;
            left: 240px;
            right: 0;
            top: 56px;
            z-index: 19;
            background: transparent;
            padding: 0 0 16px 0;
        }

        .header-tabs-card {
            margin: 0 24px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.03);
            padding: 0 32px;
            height: 56px;
            display: flex;
            align-items: flex-end;
        }

        .header-tabs {
            display: flex;
            align-items: flex-end;
            height: 56px;
            gap: 32px;
        }

        .header-tab {
            font-size: 16px;
            color: #7a8fa8;
            padding: 0 0 8px 0;
            cursor: pointer;
            position: relative;
            background: none;
            border: none;
            outline: none;
            font-family: inherit;
            transition: color 0.2s;
        }

            .header-tab.active {
                color: #204a8c;
                font-weight: bold;
            }

                .header-tab.active::after {
                    content: '';
                    display: block;
                    position: absolute;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    height: 3px;
                    border-radius: 2px;
                    background: #204a8c;
                }

        .main {
            margin-left: 220px;
            margin-top: 64px;
            padding: 24px;
            min-height: calc(100vh - 64px);
            background: #f5f6fa;
        }

        .iframe-container {
            border: 2px solid #ff3c3c;
            border-radius: 6px;
            background: #fff;
            width: 100%;
            height: 800px;
            box-sizing: border-box;
            overflow: hidden;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #fff;
        }

        .menu-group {
            margin: 0 4px 8px 4px;
            border-radius: 12px;
            background: none;
            padding: 0;
        }

            .menu-group.active {
                background: #f3f6fb;
                border-radius: 12px;
                padding: 4px 0 4px 0;
            }

        .menu-group-title {
            font-size: 13px;
            color: #999;
            font-weight: bold;
            padding: 4px 0 2px 12px;
            letter-spacing: 1px;
        }

        .menu-main-item {
            display: flex;
            align-items: flex-start;
            padding: 4px 0 8px 12px;
            font-size: 15px;
            color: #333;
            cursor: pointer;
            border-radius: 8px;
            position: relative;
            background: none;
            margin-bottom: 0;
        }

            .menu-main-item.active {
                color: #1890ff;
                font-weight: bold;
            }

            .menu-main-item .icon {
                margin-right: 8px;
                font-size: 18px;
                color: #3766b0;
                vertical-align: middle;
            }

            .menu-main-item a {
                color: #3766b0;
            }

            .menu-main-item.active .icon {
                color: #1890ff;
            }

        .main-label {
            margin-right: 8px;
            min-width: 72px;
            display: inline-block;
        }

        .submenu {
            display: flex;
            flex-direction: column;
            margin-left: 24px;
            margin-top: 0;
            flex: 1;
        }

            .submenu.two-cols {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0 16px;
                margin-left: 12px;
                margin-top: 0;
            }

        .submenu-item {
            font-size: 14px;
            color: #333;
            padding: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 0;
            transition: background 0.2s, color 0.2s;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

            .submenu-item.active {
                color: #1890ff;
                background: #e6f7ff;
                font-weight: bold;
            }

            .submenu-item:hover {
                color: #1890ff;
                background: #e6f7ff;
            }

        .menu-block {
            background: #fdfeff;
            border-radius: 12px;
            margin: 0 3px 6px 3px;
            padding: 3px 0 4px 0;
            box-shadow: none;
        }

            .menu-block.active {
                background: #eaf3ff;
            }

        .menu-main-item {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #3766b0;
            font-weight: bold;
            padding: 5px 0 7px 12px;
            line-height: 1.8;
            cursor: pointer;
            border-radius: 8px;
            background: none;
            position: relative;
        }

            .menu-main-item .icon {
                margin-right: 8px;
                font-size: 16px;
                color: #3766b0;
            }

            .menu-main-item .arrow {
                margin-left: auto;
                color: #b3c6e0;
                font-size: 12px;
            }

            .menu-main-item.active {
                color: #204a8c;
                background: none;
            }

                .menu-main-item.active .icon {
                    color: #204a8c;
                }

        .submenu {
            margin-left: 24px;
            margin-top: 0;
            display: flex;
            flex-direction: column;
            gap: 0;
        }

            .submenu.one-col {
                display: flex;
                flex-direction: column;
            }

            .submenu.two-cols {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0 24px;
            }

        .submenu-item {
            font-size: 13px;
            color: #4a5e7c;
            padding: 4px 0 4px 0;
            line-height: 2;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 0;
            transition: background 0.2s, color 0.2s;
            text-align: left;
            font-weight: normal;
        }

            .submenu-item.active {
                color: #204a8c;
                font-weight: bold;
                background: none;
            }

            .submenu-item:hover {
                color: #204a8c;
                background: none;
            }

        .sidebar-footer {
            display: none;
        }

        #popup-panel-root {
            display: none;
            position: absolute;
            background: #fff;
            box-shadow: 0 4px 24px 0 rgba(0,0,0,0.10);
            border-radius: 12px;
            padding: 16px 0;
            min-width: 240px;
            z-index: 2000;
        }

        .popup-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 24px;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 8px;
            margin: 0 8px;
        }

            .popup-card:hover {
                background: #f3f6fb;
            }

        .popup-card-title {
            font-size: 15px;
            color: #204a8c;
            font-weight: bold;
        }

        .popup-card-desc {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
        }

        .popup-card-arrow {
            color: #b3c6e0;
            font-size: 18px;
            margin-left: 16px;
            vertical-align: middle;
        }

        .qrcode-panel {
            position: absolute;
            left: 0;
            top: 0;
            min-width: 260px;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 24px 0 rgba(0,0,0,0.13);
            padding: 24px 24px 16px 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 4100;
            transition: box-shadow 0.2s;
        }

        .qrcode-img {
            width: 220px;
            height: 220px;
            margin-bottom: 12px;
            border-radius: 8px;
            background: #f5f6fa;
        }

        .qrcode-tip1 {
            font-size: 16px;
            color: #222;
            margin-top: 4px;
            font-weight: bold;
            text-align: center;
        }

        .qrcode-tip2 {
            font-size: 14px;
            color: #4a8cff;
            margin-top: 2px;
            text-align: center;
        }

        .menu-toggle-btn {
            margin-left: auto;
            color: #b3c6e0;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            outline: none;
            background: none;
            border: none;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .menu-toggle-btn:focus {
                color: #204a8c;
            }

        .menu-block[data-open="false"] .menu-toggle-btn {
            transform: rotate(180deg);
        }

        .menu-block[data-open="false"] .submenu {
            max-height: 0 !important;
            padding-bottom: 0 !important;
            overflow: hidden;
        }

        .menu-block[data-open="true"] .submenu {
            max-height: 500px;
            overflow: hidden;
        }

        .layadmin-pagetabs, .layui-layout-admin .layui-body {
            left: 200px;
        }

        .layadmin-pagetabs {
            top: 55px;
        }

        .layui-layout-admin .layui-body {
            top: 95px;
        }

        /*.layadmin-pagetabs, .layui-body, .header {
            z-index: 9;
        }

        .layui-nav-child {
            z-index: 10;
        }*/
    </style>
</head>
<body>
    <!-- 侧边菜单 -->
    <div class="sidebar">
        <div class="sidebar-logo" lay-href="Default">
            <span class="logo-title">千广传媒 · @user_type_name</span>
        </div>
        <div class="sidebar-section" style="margin-top: -12px;">
            @foreach (var item in getChildMenuList(0))
            {
                foreach (var i_tb_sys_menu in getChildMenuList(item.id))
                {
                    var i_tb_sys_menus = getChildMenuList(i_tb_sys_menu.id);

                    <div class="menu-block" data-open="true">
                        @if (i_tb_sys_menus.Count > 0)
                        {
                            <div class="menu-main-item">
                                <i class="@(i_tb_sys_menu.icon) icon"></i>
                                <span class="main-label">@i_tb_sys_menu.name</span>
                                <i class="bi bi-chevron-up arrow menu-toggle-btn" tabindex="0" style="margin-right: 11px;"></i>
                            </div>
                        }
                        else
                        {
                            if (i_tb_sys_menu.is_open == 1)
                            {
                                <div class="menu-main-item">
                                    <i class="bi bi-person-fill icon"></i>
                                    <span class="main-label"><a href="@i_tb_sys_menu.url" target="_blank" lay-tips="@i_tb_sys_menu.name" title="角色模块:@i_tb_sys_menu.introduce" lay-direction="2">@i_tb_sys_menu.name</a></span>
                                </div>
                            }
                            else
                            {
                                <div class="menu-main-item">
                                    <i class="@(i_tb_sys_menu.icon) icon"></i>
                                    <span class="main-label"><a lay-href="@i_tb_sys_menu.url" lay-tips="@i_tb_sys_menu.name" title="角色模块:@i_tb_sys_menu.introduce" lay-direction="2">@i_tb_sys_menu.name</a></span>
                                </div>
                            }
                        }
                        <div class="submenu two-cols" style="max-height: 500px; overflow: hidden; transition: max-height 0.35s cubic-bezier(.4,0,.2,1);">
                            @foreach (var ii_tb_sys_menu in i_tb_sys_menus)
                            {
                                var ii_tb_sys_menus = getChildMenuList(ii_tb_sys_menu.id);
                                if (ii_tb_sys_menus.Count > 0)
                                {
                                    <div class="submenu-item"><a lay-href="/Basic/HomePage/TIndex?menu_id=@ii_tb_sys_menu.id" title="角色流程:@ii_tb_sys_menu.introduce" style="font-size:12px;">@ii_tb_sys_menu.name</a></div>
                                }
                                else
                                {
                                    if (ii_tb_sys_menu.is_open == 1)
                                    {
                                        <div class="submenu-item"><a href="@ii_tb_sys_menu.url" target="_blank" title="角色流程:@ii_tb_sys_menu.introduce" style="font-size: 12px; display: inline; padding-right:0">@ii_tb_sys_menu.name</a></div>
                                    }
                                    else
                                    {
                                        <div class="submenu-item"><a lay-href="@ii_tb_sys_menu.url" title="角色流程:@ii_tb_sys_menu.introduce" style="font-size: 12px; display: inline; padding-right:0">@ii_tb_sys_menu.name</a></div>
                                    }
                                }
                            }
                        </div>
                    </div>
                }
            }
        </div>
        <div class="sidebar-footer">
            <i class="bi bi-chevron-bar-left icon"></i> 收起侧边栏
        </div>
    </div>
    <div id="popup-panel-fixed" style="display:none;position:fixed;z-index:3000;min-width:240px;box-shadow:0 4px 24px 0 rgba(0,0,0,0.10);border-radius:12px;background:#fff;padding:16px 0;"></div>
    <!-- 头部区域 -->
    <div class="header">
        <div class="header-left">

            <div class="header-nav-controls">
                <button class="nav-control-btn" id="toggle-sidebar-btn" title="隐藏/显示侧边栏">
                    <i class="bi bi-list"></i>
                </button>
                <button class="nav-control-btn" id="refresh-frame-btn" layadmin-event="refresh" title="刷新页面">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>

            <ul class="layui-nav layui-nav-role" lay-filter="layadmin-layout-right" style="display: none;">
                @{ var menuI = 0;}
                @foreach (var i_tb_sys_menu in ViewBag.manager_Menus)
                {
                    menuI++;
                    <li class="layui-nav-item layui-hide-xs" lay-unselect>
                        @if (menuI == 1)
                        {
                            <button class="layui-btn layui-btn-normal nav_item" nav-id="nav_@(i_tb_sys_menu.id)" style="margin:5px;" title="角色模块包:@i_tb_sys_menu.introduce">@i_tb_sys_menu.name</button>
                        }
                        else
                        {
                            <button class="layui-btn layui-btn-primary nav_item" nav-id="nav_@(i_tb_sys_menu.id)" style="margin:5px;" title="角色模块包:@i_tb_sys_menu.introduce">@i_tb_sys_menu.name</button>
                        }
                    </li>
                }
            </ul>
        </div>
        <div class="header-right">
            <div class="header-icon-btn" id="header-phone-btn"><i class="bi bi-phone"></i></div>
            <!--
            <div class="header-icon-btn"><i class="bi bi-headset"></i></div>
            <div class="header-icon-btn"><i class="bi bi-file-earmark-text"></i></div>
            <div class="header-icon-btn" style="position:relative;">
                <i class="bi bi-bell"></i>
                <span class="header-badge">29</span>
            </div>
            -->
            <div class="header-user">
                <div class="header-avatar">@(ViewBag.name.Substring(0, 1))</div>
                <div class="header-user-info">
                    <span class="header-user-name"><a lay-href="/Basic/HomePage/MyInfo">@ViewBag.name</a></span>
                    <span class="header-user-role">@ViewBag.username</span>
                </div>
            </div>
            @if (new DomainBasic.ModularFunctionApp().GetParaBool(new ModularAuthorize().getName(), "后台框架", "设置中心"))
            {
                <div><a lay-href="/Basic/HomeConfig/Default">设置中心</a></div>
            }
            <div><a href="/AuthLogin/Exit">退出</a></div>
        </div>
    </div>
    <div id="LAY_app">
        <div class="layui-layout layui-layout-admin">
            <!-- 页面标签 -->
            <div class="layadmin-pagetabs" id="LAY_app_tabs">
                <div class="layui-icon layadmin-tabs-control layui-icon-prev" layadmin-event="leftPage"></div>
                <div class="layui-icon layadmin-tabs-control layui-icon-next" layadmin-event="rightPage"></div>
                <div class="layui-icon layadmin-tabs-control layui-icon-down">
                    <ul class="layui-nav layadmin-tabs-select" lay-filter="layadmin-pagetabs-nav">
                        <li class="layui-nav-item" lay-unselect>
                            <a href="javascript:;"></a>
                            <dl class="layui-nav-child layui-anim-fadein">
                                <dd layadmin-event="closeThisTabs"><a href="javascript:;">关闭当前标签页</a></dd>
                                <dd layadmin-event="closeOtherTabs"><a href="javascript:;">关闭其它标签页</a></dd>
                                <dd layadmin-event="closeAllTabs"><a href="javascript:;">关闭全部标签页</a></dd>
                            </dl>
                        </li>
                    </ul>
                </div>
                <div class="layui-tab" lay-unauto lay-allowClose="true" lay-filter="layadmin-layout-tabs">
                    <ul class="layui-tab-title" id="LAY_app_tabsheader">
                        <li lay-id="home/console.html" lay-attr="home/console.html" class="layui-this"><i class="layui-icon layui-icon-home"></i></li>
                    </ul>
                </div>
            </div>

            <!-- 主体内容 -->
            <div class="layui-body" id="LAY_app_body">
                <div class="layadmin-tabsbody-item layui-show">
                    <iframe src="/Basic/WorkBench/Index" frameborder="0" class="layadmin-iframe"></iframe>
                </div>
            </div>
            <!-- 辅助元素，一般用于移动设备下遮罩 -->
            <div class="layadmin-body-shade" layadmin-event="shade"></div>
        </div>
    </div>

    <script type="text/javascript" src="@UtilityStatic.ConfigHelper.GetConfigString("ResourceUrl")/jquery/jquery.js"></script>
    <script type="text/javascript" src="@UtilityStatic.ConfigHelper.GetConfigString("ResourceUrl")/layui/layui.js"></script>
    <script src="@UtilityStatic.ConfigHelper.GetConfigString("ResourceUrl")/layui/common.2.0.js"></script>
    <script type="text/javascript" src="@UtilityStatic.ConfigHelper.GetConfigString("ResourceUrl")/layui/attach/notify.js"></script>

    <script>
        // 菜单展开/收起逻辑
        document.querySelectorAll('.menu-toggle-btn').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.stopPropagation();
                const block = btn.closest('.menu-block');
                const submenu = block.querySelector('.submenu');
                const isOpen = block.getAttribute('data-open') === 'true';
                if (isOpen) {
                    // 收起
                    submenu.style.maxHeight = submenu.scrollHeight + 'px'; // 先设为当前高度，触发动画
                    setTimeout(() => {
                        submenu.style.maxHeight = '0px';
                        block.setAttribute('data-open', 'false');
                    }, 10);
                } else {
                    // 展开
                    submenu.style.maxHeight = submenu.scrollHeight + 'px';
                    block.setAttribute('data-open', 'true');
                    setTimeout(() => {
                        submenu.style.maxHeight = '500px';
                    }, 350);
                }
                // 切换箭头方向由[data-open]样式控制
            });
        });


        // 侧边栏隐藏/显示功能
        const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
        const sidebar = document.querySelector('.sidebar');
        const header = document.querySelector('.header');
        const main = document.querySelector('.main');
        const layadminPagetabs = document.querySelector('.layadmin-pagetabs');
        const layuiBody = document.querySelector('.layui-body');
        const layadminTabsbodyItem = document.querySelector('.layadmin-tabsbody-item');
        const layadminIframe = document.querySelector('.layadmin-iframe');

        let sidebarCollapsed = false;

        // 检查必要的DOM元素是否存在
        if (toggleSidebarBtn && sidebar && header && layadminPagetabs && layuiBody) {
            toggleSidebarBtn.addEventListener('click', function () {
                sidebarCollapsed = !sidebarCollapsed;

                if (sidebarCollapsed) {
                    // 隐藏侧边栏
                    sidebar.classList.add('collapsed');
                    header.classList.add('sidebar-collapsed');
                    if (main) main.classList.add('sidebar-collapsed');
                    layadminPagetabs.classList.add('sidebar-collapsed');
                    layuiBody.classList.add('sidebar-collapsed');

                    // 为iframe相关元素添加样式类
                    if (layadminTabsbodyItem) layadminTabsbodyItem.classList.add('sidebar-collapsed');
                    if (layadminIframe) layadminIframe.classList.add('sidebar-collapsed');

                    // 更新图标
                    this.innerHTML = '<i class="bi bi-chevron-right"></i>';
                    this.title = '显示侧边栏';
                } else {
                    // 显示侧边栏
                    sidebar.classList.remove('collapsed');
                    header.classList.remove('sidebar-collapsed');
                    if (main) main.classList.remove('sidebar-collapsed');
                    layadminPagetabs.classList.remove('sidebar-collapsed');
                    layuiBody.classList.remove('sidebar-collapsed');

                    // 移除iframe相关元素的样式类
                    if (layadminTabsbodyItem) layadminTabsbodyItem.classList.remove('sidebar-collapsed');
                    if (layadminIframe) layadminIframe.classList.remove('sidebar-collapsed');

                    // 更新图标
                    this.innerHTML = '<i class="bi bi-list"></i>';
                    this.title = '隐藏侧边栏';
                }
            });
        }
    </script>
    <!-- 二维码弹窗 -->
    <div id="qrcode-popup" style="display:none;position:fixed;z-index:4000;left:0;top:0;width:100vw;height:100vh;">
        <div id="qrcode-popup-mask" style="position:absolute;left:0;top:0;width:100vw;height:100vh;background:transparent;"></div>
        <div class="qrcode-panel">
            <img class="qrcode-img" src="/Assets/images/mobile_view.png" alt="二维码">
            <div class="qrcode-tip1">手机扫码</div>
            <div class="qrcode-tip2">可使用移动端版本</div>
        </div>
    </div>
    <script>
        // 二维码弹窗逻辑
        const phoneBtn = document.getElementById('header-phone-btn');
        const qrPopup = document.getElementById('qrcode-popup');
        const qrPanel = document.querySelector('.qrcode-panel');
        const qrMask = document.getElementById('qrcode-popup-mask');
        function showQrPanel() {
            qrPopup.style.display = 'block';
            // 定位到icon正下方
            const btnRect = phoneBtn.getBoundingClientRect();
            const panelRect = qrPanel.getBoundingClientRect();
            let left = btnRect.left + btnRect.width / 2 - 130; // 130=260/2
            if (left < 8) left = 8;
            if (left + 260 > window.innerWidth - 8) left = window.innerWidth - 260 - 8;
            let top = btnRect.bottom + 12;
            if (top + panelRect.height > window.innerHeight - 8) top = window.innerHeight - panelRect.height - 8;
            qrPanel.style.left = left + 'px';
            qrPanel.style.top = top + 'px';
        }
        function hideQrPanel() {
            qrPopup.style.display = 'none';
        }
        let qrOpen = false;
        if (phoneBtn && qrPopup && qrPanel && qrMask) {
            phoneBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                qrOpen = !qrOpen;
                if (qrOpen) {
                    showQrPanel();
                } else {
                    hideQrPanel();
                }
            });
            qrMask.addEventListener('click', function () {
                qrOpen = false;
                hideQrPanel();
            });
            window.addEventListener('resize', function () {
                if (qrOpen) showQrPanel();
            });
            // 防止点击二维码面板关闭
            qrPanel.addEventListener('click', function (e) { e.stopPropagation(); });
        }
    </script>
    <script>
        layui.config({
            base: '/Assets/layui/layuiadmin/' //静态资源所在路径
        }).extend({
            index: 'lib/index' //主入口模块
        }).use('index');

        window.onload = function () {
            if (window.top != window.self) {
                window.top.location = window.self.location;
            }
        }

        //interval_StatisticData();
        //statisticData();

        function interval_StatisticData() {
            return setInterval(() => {
                statisticData();
            }, 60000);
        }

        function statisticData() {
            $.ajax({
                type: "get",
                url: "/Basic/HomeApprove/HandleCount",
                dataType: "json",
                success: function (res) {
                    if (res.code === 0) {
                        $("#approveData").html(res.data);
                    }
                    else {
                        layer.msg(res.msg, {
                            icon: 5,
                            time: 1000
                        })
                    }
                }
            });
        }

        $(".change_role").click(function () {
            $.ajax({
                type: "get",
                url: "/Basic/HomePage/ChangeRole?manager_role_id=" + $(this).attr("data-id"),
                dataType: "json",
                success: function (res) {
                    if (res.code === 0) {
                        layer.msg("角色切换成功", {
                            icon: 1,
                            time: 1000
                        })
                        location.href = "/Home/Index";
                    }
                    else {
                        layer.msg(res.msg, {
                            icon: 5,
                            time: 1000
                        })
                    }
                }
            });
        })

        $(".nav_item").click(function () {
            $(".layui-nav-tree").addClass("layui-hide");
            $(".layui-nav-tree[nav-id=" + $(this).attr("nav-id") + "]").removeClass("layui-hide");

            $(".layui-nav-role .nav_item").addClass("layui-btn-primary");
            $(".layui-nav-role .nav_item").removeClass("layui-btn-normal");
            $(this).addClass("layui-btn-normal");
            $(this).removeClass("layui-btn-primary");
        })
    </script>
    @if (new DomainBasic.ModularFunctionApp().GetParaBool(new ModularAuthorize().getName(), "后台框架", "轮询提醒"))
    {
        string url = new DomainBasic.ModularConfigApp().GetFunctionContent(new ModularAuthorize().getName(), "后台框架_轮询提醒", "请求网址");
        if (url.IsNullOrEmpty())
        {
            url = "无效url";
            <script>alert("轮询提醒未设置请求网址")</script>
        }
        <script>
        setInterval("LayerMsg()", @(new DomainBasic.ModularConfigApp().GetFunctionContent(new ModularAuthorize().getName(), "后台框架_轮询提醒", "请求频率")) * 1000);
        function LayerMsg() {
            $.ajax({
            type: "post",
            url: "@(url)",
            dataType: "json",
            success: function (res) {
                if (res.code === 0) {
                    if (res.msg != "") {
                        notify.info({
                            msg: res.msg,
                            closable: true,
                            shadow: true,
                            duration: 3000
                        });
                    }
                }
                else {
                    layer.msg(res.msg, {
                        icon: 5,
                        time: 1000
                        })
                    }
                }
            });
        }
        </script>
    }
</body>
</html>

@functions
{
    public List<ModelDbModularBasic.sys_modular_menu> getChildMenuList(int parent_id, sbyte n_type = 1)
    {
        return DoMySql.FindList<ModelDbModularBasic.sys_modular_menu>($"parent_id = '{parent_id}' AND n_type = '{n_type}' AND id IN (SELECT menu_id FROM sys_role__menu WHERE role_id = {new UserIdentityBag("user").cur_role_id}) AND id NOT IN (SELECT data_id FROM sys_role__extra WHERE tenant_id = '{new DomainBasic.TenantApp().GetInfo().id}' AND user_type_id = '{new DomainBasic.TenantDomainApp().GetInfo().user_type_id}' AND b_type = 1 AND c_type = 1) ORDER BY sort, id desc");
    }

    public string getSpread(sbyte? spread)
    {
        if (spread == 1) return "layui-nav-itemed";
        return "";
    }
}


