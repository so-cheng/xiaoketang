
@using WeiCode.Utility;
@using WeiCode.DataBase;
@using WeiCode.Services;

@using WeiCode.Domain;
@using WeiCode.Models;
@using WeiCode.ModelDbs;
@using Services.Project;
@using System.Reflection;

@model Services.Project.PageFactory.DangBiao.TableVO

<!-- 页面通用母版 -->
@{
    Layout = ModelBasic.PageModel.GetLayout();
    var roles = new DomainBasic.DictionaryApp().GetListForOption("档位角色");
    var dangs = new DomainBasic.DictionaryApp().GetListForOption("档位时段");
    var p_jixiao_dangbiao_item = DoMySql.FindEntity<ModelDb.p_jixiao_dangbiao_item>($"db_sn='{ViewBag.db_sn}'", false);
    string[] memos = new string[8];
    if (!p_jixiao_dangbiao_item.memo.IsNullOrEmpty())
    {
        memos = p_jixiao_dangbiao_item.memo.Split('@');
    }
    var p_jixiao_dangbiao = DoMySql.FindEntity<ModelDb.p_jixiao_dangbiao>($"id = {ViewBag.db_id}", false);
    var tableItem = DoMySql.FindEntity<ModelDb.p_jixiao_dangbiao_item>($"db_sn = '{p_jixiao_dangbiao.db_sn}'", false);
    var zbsrColorList = tableItem.zbsr_color_db.ToModel<List<PageFactory.DangBiao.ZbsrColor>>();
    var zbInfos = new ServiceFactory.UserInfo.Tg().TgGetNextZb(new UserIdentityBag().user_sn);
    foreach (var item in zbInfos)
    {
        var zbsrColor = zbsrColorList.Where(c => c.user_sn == item.user_sn).FirstOrDefault();
        if (!zbsrColor.IsNullOrEmpty())
        {
            item.db_color = zbsrColor.color;
        }
        else
        {
            item.db_color = "#E8F5E9";
        }
    }

}
<style>
    .layui-table td, .layui-table th, .layui-table-col-set, .layui-table-fixed-r,
    .layui-table-grid-down, .layui-table-header, .layui-table-page, .layui-table-tips-main,
    .layui-table-tool, .layui-table-total, .layui-table-view, .layui-table[lay-skin=line], .layui-table[lay-skin=row] {
        border-collapse: collapse;
        border-style: solid;
        border-width: 1px;
        border-color: gray;
    }

    .layui-table th {
        text-align: center;
        font-weight: 700;
        font-size: 15px;
        color: black;
    }

    .layui-table td {
        font-size: 15px;
        color: black;
    }
</style>
<!-- 以下书写自己的页面内容代码 -->
<form id="mainForm" class="layui-form" action="table">
    <div class="layui-row">
        <div class="layui-col-md8">
            <div class="layui-inline">
                <label class="layui-input-inline" style="font-size:18px; font-weight:bold">@Html.Raw(ViewBag.ting_name)&nbsp;&nbsp;档表</label>
                <div class="layui-input-inline">
                    @ViewModelBag.Load(Html, new ModelBasic.EmtTimeSelect("c_date")
               {
                   mold = WeiCode.Models.ModelBasic.EmtTimeSelect.Mold.date_range,
                   placeholder = "选择日期",
                   defaultValue = Model.c_date,
               })
                </div>
            </div>

            <div class="layui-input-inline" style="width:500px;">

                @ViewModelBag.Load(Html, new ModelBasic.EmtInput("note")
           {
               title = "备注",
               placeholder = "备注",
               defaultValue = Model.note
           })
            </div>
            <div class="layui-inline">
                <div class="layui-input-inline">
                    @ViewModelBag.Load(Html, new ModelBasic.EmtHidden("table_id")
               {
                   placeholder = "table_id",
                   defaultValue = @Model.table_id.ToString(),
               })
                </div>
            </div>
        </div>
        <div class="layui-col-md1" style="text-align:right">
            <button type="button" class="layui-btn layui-btn-normal btn-submit">保存档表</button>
        </div>
    </div>
    <div class="layui-row">
        <div class="layui-col-md9">
            <div class="layui-col-md1" style="text-align:left">
                @ViewModelBag.Load(Html, new ModelBasic.EmtSelect("ting_sn")
                {
                    options = new ServiceFactory.UserInfo.Ting().GetTingsKvByTgsn(ViewBag.ting_sn),
                    defaultValue = ViewBag.ting_sn,
                    placeholder = "所属厅",
                    eventJsChange = new EmtFormBase.EventJsChange
                    {
                        eventJavascript = new EventJavascript
                        {
                            code = $"window.location.href='table?ting_sn='+ $('#ting_sn').val();",
                        },
                    },
                })
            </div>
            <table class="layui-table" style="width:100%;" id="table1">
                <tr style="background-color: #FCE4D3">
                    <td colspan="@(roles.Count + 2)" style="font-size: 18px; text-align: center; font-weight: bold">@Html.Raw(ViewBag.ting_name)&nbsp;&nbsp;档表(@Model.c_date)</td>
                </tr>
                <tr style="background-color: #FCE4D3;">
                    <td style="width: 75px; text-align: center">档位</td>
                    <td style="width: 90px; text-align: center">时间</td>
                    @foreach (var items in roles)
                    {
                        if (items.Key == "挂1")
                        {
                            <td style="text-align:center">
                                <select lay-ignore style="border: 0; background-color: #FCE4D3; color: #666666; font-size: 16px; text-align: center; width: 100% " name="dang_wei_role">
                                    <option value="挂1">挂1</option>
                                    <option value="陪" @(Model.dang_wei_role == "陪" ? "selected" : "")>陪</option>
                                </select>
                            </td>
                        }
                        else
                        {
                            <td style="text-align:center">@items.Key</td>
                        }
                    }
                </tr>
                </tr>
                @{
                    int i = -1;
                    foreach (var item in dangs)
                    {
                        for (var _i = 1; _i <= 3; _i++)
                        {
                            int zfp_i = 0;
                            string zfp_class = "";
                            i++;

                            //获取表格中每行的值
                            string[] roles_values = null;
                            Type type = typeof(PageFactory.DangBiao.TableVO);
                            PropertyInfo prop = type.GetProperty("zb_" + i);
                            if (prop != null && prop.CanRead)
                            {
                                roles_values = prop.GetValue(Model) as string[];
                            }

                            <tr style="background-color: white ">
                                @if (_i == 1)
                                {
                                    <td rowspan="3" style="text-align: center; background-color: #FCE4D3"> @item.Key</td>
                                }
                                @{var time_text = i + ":00-" + (i + 1) + ":00";}
                                <td style="text-align:center">@time_text</td>
                                @{
                                    int j = -1;
                                    foreach (var _item in roles)
                                    {
                                        zfp_i++;
                                        j++;
                                        if (zfp_i < 4)
                                        {
                                            zfp_class = "zb_zfp";
                                        }
                                        else
                                        {
                                            zfp_class = "zb_gw";
                                        }
                                        <td style="background-color:@(zbInfos.Where(x=>x.user_sn==roles_values[j]).FirstOrDefault()?.db_color ?? "white")">
                                            <select lay-ignore style="border: 0; color: #666666; font-size: 16px; background-color: @(zbInfos.Where(x=>x.user_sn==roles_values[j]).FirstOrDefault()?.db_color ?? "white");text-align:center;width:100%" name="zb_@i" class="zb_@(item.Value)_@(_i)_@(_item.Value) zb_@i @zfp_class" onchange="countZbNum(); changeColor(this)">
                                                <option value=""></option>
                                                @foreach (var __item in zbInfos)
                                                {
                                                    <option value="@__item.user_sn" scolor="@__item.db_color" @(roles_values[j] == __item.user_sn ? "selected" : "")>@__item.name</option>
                                                }
                                            </select>
                                        </td>
                                    }
                                }
                            </tr>
                        }
                    }
                }
            </table>
        </div>
        <div class="layui-col-md3" style="padding:10px;">
            <div style="font-size: 16px; padding: 10px;">主副陪角色轮流分配</div>
            <select id="zfp_dang">
                @foreach (var __item in dangs)
                {
                    <option value="@__item.Value">@__item.Key</option>
                }
            </select>
            <br />
            <select id="zfp_zb1">
                <option value="">选择主播</option>
                @foreach (var __item in zbInfos)
                {
                    <option value="@__item.user_sn" scolor="@__item.db_color">@__item.name</option>
                }
            </select>
            <br />
            <select id="zfp_zb2">
                <option value="">选择主播</option>
                @foreach (var __item in zbInfos)
                {
                    <option value="@__item.user_sn" scolor="@__item.db_color">@__item.name</option>
                }
            </select>
            <br />
            <select id="zfp_zb3">
                <option value="">选择主播</option>
                @foreach (var __item in zbInfos)
                {
                    <option value="@__item.user_sn" scolor="@__item.db_color">@__item.name</option>
                }
            </select>
            <br />
            <button type="button" class="layui-btn layui-btn-primary layui-btn-sm" onclick="setZFP()">批量设置</button>
            <hr />
            <div style="font-size: 16px; padding: 10px;">挂位角色批量设置</div>
            @ViewModelBag.Load(Html, new ModelBasic.EmtExt.XmSelect("gw_dangs")
            {
                bindOptions = new DomainBasic.DictionaryApp().GetListForOption(ModelEnum.DictCategory.档位时段)
            })
            <br />
            <select id="gw_role_1">
                <option value="">选择角色</option>
                @foreach (var __item in roles)
                {
                    if (__item.Value.ToInt() < 4)
                    {
                        continue;
                    }
                    <option value="@__item.Value">@__item.Key</option>
                }
            </select>
            <br />
            <select id="gw_zb1">
                <option value="">选择主播</option>
                @foreach (var __item in zbInfos)
                {
                    <option value="@__item.user_sn" scolor="@__item.db_color">@__item.name</option>
                }
            </select>
            <br />
            <button type="button" class="layui-btn layui-btn-primary layui-btn-sm" onclick="setGW()">批量设置</button>

            <table class="layui-table" style="width:100%;">
                <tr>
                    <th style="width: 40%">主播</th>
                    <th style="width: 30%">主副陪(小时)</th>
                    <th style="width: 30%">挂位(小时)</th>
                </tr>
                @{
                    var zbsr_colorList = new List<PageFactory.DangBiao.ZbsrColor>();
                }
                @foreach (var __item in zbInfos)
                {
                    <tr style="background-color: @__item.db_color ">
                        <td>
                            @{
                                var zbsr_color = new PageFactory.DangBiao.ZbsrColor();
                                zbsr_color.user_sn = __item.user_sn;
                                zbsr_color.color = __item.color;
                                zbsr_colorList.Add(zbsr_color);
                            }

                            @__item.name
                        </td>
                        <td id="zfp_@(__item.user_sn)" class="num">0</td>
                        <td id="gw_@(__item.user_sn)" class="num">0</td>
                    </tr>
                }
                <input type="hidden" name="zbys" value="@zbsr_colorList.ToJson()">
            </table>

        </div>
        <div class="layui-col-md12" style="padding:10px;">
            <div style="font-size: 16px; padding: 10px;">每档备注</div>
            <div class="layui-col-md3">
                @ViewModelBag.Load(Html, new ModelBasic.EmtInput("memo_1")
                {
                    title = "第一档备注",
                    placeholder = "第一档备注",
                    defaultValue = memos.Length == 8 ? memos[0] : ""
                })
            </div>
            <div class="layui-col-md3">
                @ViewModelBag.Load(Html, new ModelBasic.EmtInput("memo_2")
                {
                    title = "第二档备注",
                    placeholder = "第二档备注",
                    defaultValue = memos.Length == 8 ? memos[1] : ""
                })
            </div>
            <div class="layui-col-md3">
                @ViewModelBag.Load(Html, new ModelBasic.EmtInput("memo_3")
                {
                    title = "第三档备注",
                    placeholder = "第三档备注",

                    defaultValue = memos.Length == 8 ? memos[2] : ""
                })
            </div>
            <div class="layui-col-md3">
                @ViewModelBag.Load(Html, new ModelBasic.EmtInput("memo_4")
                {
                    title = "第四档备注",
                    placeholder = "第四档备注",

                    defaultValue = memos.Length == 8 ? memos[3] : ""
                })
            </div>
        </div>
        <div class="layui-col-md12" style="padding:10px;">
            <br />
            <div class="layui-col-md3">
                @ViewModelBag.Load(Html, new ModelBasic.EmtInput("memo_5")
                {
                    title = "第五档备注",
                    placeholder = "第五档备注",

                    defaultValue = memos.Length == 8 ? memos[4] : ""
                })
            </div>
            <div class="layui-col-md3">
                @ViewModelBag.Load(Html, new ModelBasic.EmtInput("memo_6")
                {
                    title = "第六档备注",
                    placeholder = "第六档备注",
                    defaultValue = memos.Length == 8 ? memos[5] : ""
                })
            </div>
            <div class="layui-col-md3">
                @ViewModelBag.Load(Html, new ModelBasic.EmtInput("memo_7")
                {
                    title = "第七档备注",
                    placeholder = "第七档备注",
                    defaultValue = memos.Length == 8 ? memos[6] : ""
                })
            </div>
            <div class="layui-col-md3">
                @ViewModelBag.Load(Html, new ModelBasic.EmtInput("memo_8")
                {
                    title = "第八档备注",
                    placeholder = "第八档备注",
                    defaultValue = memos.Length == 8 ? memos[7] : ""
                })
            </div>
        </div>
    </div>
</form>
<script>
    layui.use('form', function () {
        var form = layui.form;
        form.render('select'); // 仅渲染 select 元素
    });
    function setZFP() {
        $(".zb_" + $("#zfp_dang").val() + "_1_1").val($("#zfp_zb1").val());
        $(".zb_" + $("#zfp_dang").val() + "_1_1").parent().css("background-color", $("#zfp_zb1").find("option:selected").attr("scolor"));
        $(".zb_" + $("#zfp_dang").val() + "_1_1").css("background-color", $("#zfp_zb1").find("option:selected").attr("scolor"));
        $(".zb_" + $("#zfp_dang").val() + "_2_1").val($("#zfp_zb2").val());
        $(".zb_" + $("#zfp_dang").val() + "_2_1").parent().css("background-color", $("#zfp_zb2").find("option:selected").attr("scolor"));
        $(".zb_" + $("#zfp_dang").val() + "_2_1").css("background-color", $("#zfp_zb2").find("option:selected").attr("scolor"));
        $(".zb_" + $("#zfp_dang").val() + "_3_1").val($("#zfp_zb3").val());
        $(".zb_" + $("#zfp_dang").val() + "_3_1").parent().css("background-color", $("#zfp_zb3").find("option:selected").attr("scolor"));
        $(".zb_" + $("#zfp_dang").val() + "_3_1").css("background-color", $("#zfp_zb3").find("option:selected").attr("scolor"));
        $(".zb_" + $("#zfp_dang").val() + "_1_2").val($("#zfp_zb2").val());
        $(".zb_" + $("#zfp_dang").val() + "_1_2").parent().css("background-color", $("#zfp_zb2").find("option:selected").attr("scolor"));
        $(".zb_" + $("#zfp_dang").val() + "_1_2").css("background-color", $("#zfp_zb2").find("option:selected").attr("scolor"));
        $(".zb_" + $("#zfp_dang").val() + "_2_2").val($("#zfp_zb3").val());
        $(".zb_" + $("#zfp_dang").val() + "_2_2").parent().css("background-color", $("#zfp_zb3").find("option:selected").attr("scolor"));
        $(".zb_" + $("#zfp_dang").val() + "_2_2").css("background-color", $("#zfp_zb3").find("option:selected").attr("scolor"));
        $(".zb_" + $("#zfp_dang").val() + "_3_2").val($("#zfp_zb1").val());
        $(".zb_" + $("#zfp_dang").val() + "_3_2").parent().css("background-color", $("#zfp_zb1").find("option:selected").attr("scolor"));
        $(".zb_" + $("#zfp_dang").val() + "_3_2").css("background-color", $("#zfp_zb1").find("option:selected").attr("scolor"));
        $(".zb_" + $("#zfp_dang").val() + "_1_3").val($("#zfp_zb3").val());
        $(".zb_" + $("#zfp_dang").val() + "_1_3").parent().css("background-color", $("#zfp_zb3").find("option:selected").attr("scolor"));
        $(".zb_" + $("#zfp_dang").val() + "_1_3").css("background-color", $("#zfp_zb3").find("option:selected").attr("scolor"));
        $(".zb_" + $("#zfp_dang").val() + "_2_3").val($("#zfp_zb1").val());
        $(".zb_" + $("#zfp_dang").val() + "_2_3").parent().css("background-color", $("#zfp_zb1").find("option:selected").attr("scolor"));
        $(".zb_" + $("#zfp_dang").val() + "_2_3").css("background-color", $("#zfp_zb1").find("option:selected").attr("scolor"));
        $(".zb_" + $("#zfp_dang").val() + "_3_3").val($("#zfp_zb2").val());
        $(".zb_" + $("#zfp_dang").val() + "_3_3").parent().css("background-color", $("#zfp_zb2").find("option:selected").attr("scolor"));
        $(".zb_" + $("#zfp_dang").val() + "_3_3").css("background-color", $("#zfp_zb2").find("option:selected").attr("scolor"));
        countZbNum();
    }

    function setGW() {
        $.each(gw_dangs.getValue(), function (i, item) {
            $(".zb_" + item.value + "_1" + "_" + $("#gw_role_1").val()).val($("#gw_zb1").val());
            $(".zb_" + item.value + "_1" + "_" + $("#gw_role_1").val()).parent().css("background-color", $("#gw_zb1").find("option:selected").attr("scolor"));
            $(".zb_" + item.value + "_1" + "_" + $("#gw_role_1").val()).css("background-color", $("#gw_zb1").find("option:selected").attr("scolor"));
            $(".zb_" + item.value + "_2" + "_" + $("#gw_role_1").val()).val($("#gw_zb1").val());
            $(".zb_" + item.value + "_2" + "_" + $("#gw_role_1").val()).parent().css("background-color", $("#gw_zb1").find("option:selected").attr("scolor"));
            $(".zb_" + item.value + "_2" + "_" + $("#gw_role_1").val()).css("background-color", $("#gw_zb1").find("option:selected").attr("scolor"));
            $(".zb_" + item.value + "_3" + "_" + $("#gw_role_1").val()).val($("#gw_zb1").val());
            $(".zb_" + item.value + "_3" + "_" + $("#gw_role_1").val()).parent().css("background-color", $("#gw_zb1").find("option:selected").attr("scolor"));
            $(".zb_" + item.value + "_3" + "_" + $("#gw_role_1").val()).css("background-color", $("#gw_zb1").find("option:selected").attr("scolor"));
        })
        countZbNum();
    }

    function countZbNum() {
        $(".num").html("0")
        $.each($(".zb_zfp"), function (i, item) {
            $("#zfp_" + $(item).val()).html(parseInt($("#zfp_" + $(item).val()).html(), 10) + 1);
        })
        $.each($(".zb_gw"), function (i, item) {
            $("#gw_" + $(item).val()).html(parseInt($("#gw_" + $(item).val()).html(), 10) + 1);
        })
    }
    countZbNum()


    function changeColor(selectElem) {
        const selectedIndex = selectElem.selectedIndex;
        const option = selectElem.options[selectedIndex];
        const color = option.getAttribute('scolor')
        selectElem.style.backgroundColor = color;
        selectElem.closest('td').style.backgroundColor = color;
    }
</script>